# -----------------------------------------------------------------------------------------------------------------------------#
# Import
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ ì„¹ì…˜ì—ì„œëŠ” í”„ë¡œê·¸ë¨ ë™ì‘ì— í•„ìš”í•œ ëª¨ë“  ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ë‚´ë¶€ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
# ê° ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” íŠ¹ì • ê¸°ëŠ¥ì„ ë‹´ë‹¹í•˜ë©°, ë°ì´í„° ìˆ˜ì§‘, AI ë¶„ì„, ì˜ìƒ ì œì‘, ë©”ì¼ ë°œì†¡ ë“±ì˜ ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

import os                                                               # ìš´ì˜ì²´ì œ í™˜ê²½ ë³€ìˆ˜ ì ‘ê·¼ ë° íŒŒì¼ ì‹œìŠ¤í…œ ê´€ë ¨ ê¸°ëŠ¥ ì œê³µ
import time                                                             # ì‹œê°„ ì§€ì—°(sleep) ë° íƒ€ì´ë° ê´€ë ¨ ê¸°ëŠ¥ ì œê³µ
import json                                                             # JSON ë°ì´í„° íŒŒì‹± ë° ìƒì„±ì„ ìœ„í•œ í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬
import re                                                               # ì •ê·œ í‘œí˜„ì‹ì„ ì´ìš©í•œ ë¬¸ìì—´ íŒ¨í„´ ë§¤ì¹­ ë° ë³€í™˜
import schedule                                                         # ìŠ¤ì¼€ì¤„ë§ ë¼ì´ë¸ŒëŸ¬ë¦¬ (í˜„ì¬ One-Shot ëª¨ë“œì—ì„œëŠ” ë¯¸ì‚¬ìš©)
import smtplib                                                          # SMTP í”„ë¡œí† ì½œì„ ì´ìš©í•œ ì´ë©”ì¼ ë°œì†¡ ê¸°ëŠ¥
import feedparser                                                       # RSS/Atom í”¼ë“œ íŒŒì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬ (Google News RSS íŒŒì‹±ìš©)
import trafilatura                                                      # ì›¹í˜ì´ì§€ì—ì„œ ë³¸ë¬¸ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œí•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
import urllib.parse                                                     # URL ì¸ì½”ë”©/ë””ì½”ë”© ìœ í‹¸ë¦¬í‹° (ê²€ìƒ‰ ì¿¼ë¦¬ ì¸ì½”ë”©ìš©)
import requests                                                         # HTTP ìš”ì²­ì„ ë³´ë‚´ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì›¹í˜ì´ì§€ í¬ë¡¤ë§, API í˜¸ì¶œìš©)
import yfinance as yf                                                   # Yahoo Finance API ë˜í¼ (ì£¼ì‹ ì‹œì„¸ ë° ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ìš©)

from datetime import datetime, timedelta                                # ë‚ ì§œ/ì‹œê°„ ê³„ì‚°ìš© (24ì‹œê°„ ì´ë‚´ í•„í„°ë§ ë“±)
from email.mime.text import MIMEText                                    # ì´ë©”ì¼ ë³¸ë¬¸(í…ìŠ¤íŠ¸/HTML) ìƒì„±ìš©
from googleapiclient.discovery import build                             # Google API í´ë¼ì´ì–¸íŠ¸ (YouTube Data API v3 ì‚¬ìš©)
from youtube_transcript_api import YouTubeTranscriptApi                 # ìœ íŠœë¸Œ ì˜ìƒ ìë§‰ ì¶”ì¶œ ë¼ì´ë¸ŒëŸ¬ë¦¬

import google.generativeai as genai                                     # Google Gemini AI API (í…ìŠ¤íŠ¸ ë¶„ì„ ë° ìƒì„±)
import video_studio                                                     # ì»¤ìŠ¤í…€ ëª¨ë“ˆ: ì˜ìƒ ì œì‘ ê´€ë ¨ ê¸°ëŠ¥ ë‹´ë‹¹
import youtube_manager                                                  # ì»¤ìŠ¤í…€ ëª¨ë“ˆ: ìœ íŠœë¸Œ ì—…ë¡œë“œ ë° ê´€ë¦¬ ê¸°ëŠ¥ ë‹´ë‹¹
import glob                                                             # íŒŒì¼ íŒ¨í„´ ë§¤ì¹­ (ì™€ì¼ë“œì¹´ë“œë¡œ íŒŒì¼ ê²€ìƒ‰)

import pandas_market_calendars as mcal                                  # ì£¼ì‹ ì‹œì¥ ìº˜ë¦°ë” (íœ´ì¥ì¼/ê°œì¥ì¼ í™•ì¸ìš©)
import pytz                                                             # íƒ€ì„ì¡´ ë³€í™˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ (UTC â†” ë‰´ìš• ì‹œê°„ ë³€í™˜)

import smtplib                                                          # (ì¤‘ë³µ import - ì´ë¯¸ ìœ„ì—ì„œ importë¨)
from email.mime.multipart import MIMEMultipart                          # ë³µí•© ì´ë©”ì¼ ë©”ì‹œì§€ ìƒì„± (ë³¸ë¬¸+ì²¨ë¶€íŒŒì¼)
from email.mime.text import MIMEText                                    # (ì¤‘ë³µ import - ì´ë¯¸ ìœ„ì—ì„œ importë¨)
from email.mime.image import MIMEImage                                  # ì´ë©”ì¼ì— ì´ë¯¸ì§€ ì²¨ë¶€ìš©

# [ì¶”ê°€] Selenium ë¼ì´ë¸ŒëŸ¬ë¦¬ (ê³µí¬ì§€ìˆ˜ í¬ë¡¤ë§ìš©)
# CNN Fear & Greed Index í˜ì´ì§€ëŠ” JavaScriptë¡œ ë Œë”ë§ë˜ë¯€ë¡œ Selenium ë¸Œë¼ìš°ì € ìë™í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.
from selenium import webdriver                                          # ì›¹ ë¸Œë¼ìš°ì € ìë™í™” ë“œë¼ì´ë²„
from selenium.webdriver.chrome.options import Options                   # Chrome ë¸Œë¼ìš°ì € ì˜µì…˜ ì„¤ì •
from selenium.webdriver.chrome.service import Service as ChromeService  # Chrome ì„œë¹„ìŠ¤ ê´€ë¦¬
from selenium.webdriver.common.by import By                             # ì›¹ ìš”ì†Œ íƒìƒ‰ ë°©ë²• ì§€ì • (ID, CLASS, TAG ë“±)


# -----------------------------------------------------------------------------------------------------------------------------#
# Set Environment
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ ì„¹ì…˜ì—ì„œëŠ” í”„ë¡œê·¸ë¨ ì‹¤í–‰ì— í•„ìš”í•œ API í‚¤ì™€ ì¸ì¦ ì •ë³´ë¥¼ í™˜ê²½ ë³€ìˆ˜ì—ì„œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
# ëª¨ë“  ë¯¼ê°í•œ ì •ë³´ëŠ” .env íŒŒì¼ì— ì €ì¥ë˜ì–´ ìˆìœ¼ë©°, Docker í™˜ê²½ì—ì„œ ì£¼ì…ë©ë‹ˆë‹¤.
# ë³´ì•ˆìƒ ì½”ë“œì— ì§ì ‘ í‚¤ë¥¼ í•˜ë“œì½”ë”©í•˜ì§€ ì•Šê³  í™˜ê²½ ë³€ìˆ˜ë¥¼ í†µí•´ ê´€ë¦¬í•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

GOOGLE_API_KEY  = os.getenv('GOOGLE_API_KEY')   # Google Gemini AI API í‚¤ (AI ë¶„ì„/ëŒ€ë³¸ ìƒì„±ìš©)
YOUTUBE_API_KEY = os.getenv('YOUTUBE_API_KEY')  # YouTube Data API v3 í‚¤ (ì˜ìƒ ê²€ìƒ‰/ì±„ë„ ì •ë³´ ìˆ˜ì§‘ìš©)
EMAIL_SENDER    = os.getenv('EMAIL_SENDER')     # ë°œì‹ ì ì´ë©”ì¼ ì£¼ì†Œ (Gmail)
EMAIL_PASSWORD  = os.getenv('EMAIL_PASSWORD')   # Gmail ì•± ë¹„ë°€ë²ˆí˜¸ (2ë‹¨ê³„ ì¸ì¦ í•„ìš”)

# Google Gemini AI API ì´ˆê¸°í™”
# ì´í›„ genai.GenerativeModel()ë¡œ ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
genai.configure(api_key=GOOGLE_API_KEY)

# Gemini AI ì•ˆì „ ì„¤ì • ì •ì˜
# ê¸ˆìœµ/íˆ¬ì ê´€ë ¨ ì½˜í…ì¸ ê°€ ìœ í•´ ì½˜í…ì¸ ë¡œ ì˜¤ì¸ë˜ì–´ ì°¨ë‹¨ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´
# ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ ì°¨ë‹¨ ì„ê³„ê°’ì„ BLOCK_NONE(ì°¨ë‹¨ ì•ˆ í•¨)ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
# ì¹´í…Œê³ ë¦¬: ê´´ë¡­í˜, í˜ì˜¤ ë°œì–¸, ì„±ì  ì½˜í…ì¸ , ìœ„í—˜í•œ ì½˜í…ì¸ 
safety_settings = [
    { "category": "HARM_CATEGORY_HARASSMENT"       , "threshold": "BLOCK_NONE" },
    { "category": "HARM_CATEGORY_HATE_SPEECH"      , "threshold": "BLOCK_NONE" },
    { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
    { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" },
]



# -----------------------------------------------------------------------------------------------------------------------------#
# Find AI Model
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš© ê°€ëŠ¥í•œ Gemini AI ëª¨ë¸ ì¤‘ ê°€ì¥ ì í•©í•œ ëª¨ë¸ì„ ìë™ìœ¼ë¡œ ì„ íƒí•©ë‹ˆë‹¤.
# Google AI Studioì—ì„œ ì œê³µí•˜ëŠ” ëª¨ë¸ì€ ì‹œê°„ì— ë”°ë¼ ë³€ê²½ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ,
# ë™ì ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ì„ ì¡°íšŒí•˜ê³  ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì„ íƒí•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

def get_working_model():
    """
    ì‚¬ìš© ê°€ëŠ¥í•œ Gemini AI ëª¨ë¸ì„ ì¡°íšŒí•˜ê³  ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ìµœì ì˜ ëª¨ë¸ì„ ì„ íƒí•©ë‹ˆë‹¤.
    
    [ëª¨ë¸ ì„ íƒ ìš°ì„ ìˆœìœ„]
    1. Flash ëª¨ë¸: ë¹ ë¥¸ ì‘ë‹µ ì†ë„, ë°°ì¹˜ ì²˜ë¦¬ì— ìœ ë¦¬ (ì˜ˆ: gemini-2.0-flash)
    2. 1.5-Pro ëª¨ë¸: ê³ í’ˆì§ˆ ì‘ë‹µ, ë³µì¡í•œ ë¶„ì„ì— ì í•©
    3. gemini-pro: ê¸°ë³¸ ëª¨ë¸, í´ë°±ìš©
    
    Returns:
        genai.GenerativeModel: ì„ íƒëœ AI ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤
    """
    print("ğŸ¤– AI ëª¨ë¸ ì—°ê²° ì‹œë„ ì¤‘...")
    try:
        # [Step 1] ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  ëª¨ë¸ ì¤‘ 'generateContent' ë©”ì„œë“œë¥¼ ì§€ì›í•˜ëŠ” ëª¨ë¸ë§Œ í•„í„°ë§
        # ì¼ë¶€ ëª¨ë¸ì€ í…ìŠ¤íŠ¸ ìƒì„±ì´ ì•„ë‹Œ ì„ë² ë”© ì „ìš©ì´ë¯€ë¡œ ì œì™¸í•´ì•¼ í•©ë‹ˆë‹¤.
        valid_models = []
        for m in genai.list_models():
            if 'generateContent' in m.supported_generation_methods:
                valid_models.append(m.name)

        # [Step 2] ìš°ì„ ìˆœìœ„ ê¸°ë°˜ ëª¨ë¸ ì„ íƒ
        # Flash ëª¨ë¸ì´ ê°€ì¥ ë¹ ë¥´ê³  ë¹„ìš© íš¨ìœ¨ì ì´ë¯€ë¡œ ìš°ì„  ì„ íƒ
        # ìš°ì„ ìˆœìœ„: Flash (Batch ìœ ë¦¬) -> Pro -> êµ¬í˜•
        preference = ['flash', '1.5-pro', 'gemini-pro']
        selected_model = None

        # ìš°ì„ ìˆœìœ„ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆœíšŒí•˜ë©° í•´ë‹¹ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ì²« ë²ˆì§¸ ëª¨ë¸ ì„ íƒ
        for pref in preference:
            for m_name in valid_models:
                if pref in m_name:
                    selected_model = m_name
                    break
            if selected_model: break  # ëª¨ë¸ì„ ì°¾ìœ¼ë©´ ë£¨í”„ ì¢…ë£Œ

        # [Step 3] ìš°ì„ ìˆœìœ„ì— ë§ëŠ” ëª¨ë¸ì´ ì—†ìœ¼ë©´ ë¦¬ìŠ¤íŠ¸ì˜ ì²« ë²ˆì§¸ ëª¨ë¸ ì‚¬ìš©
        if not selected_model and valid_models:
            selected_model = valid_models[0]

        print(f"  âœ… ìµœì¢… ì„ íƒëœ ëª¨ë¸: {selected_model}")
        return genai.GenerativeModel(selected_model)
    except:
        # [í´ë°±] API ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ëª¨ë¸ ë°˜í™˜
        return genai.GenerativeModel('gemini-pro')

# í”„ë¡œê·¸ë¨ ì‹œì‘ ì‹œ ìµœì ì˜ AI ëª¨ë¸ì„ ì„ íƒí•˜ì—¬ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
# ì´í›„ ëª¨ë“  AI ë¶„ì„/ìƒì„± ì‘ì—…ì—ì„œ ì´ model ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
model = get_working_model()



# -----------------------------------------------------------------------------------------------------------------------------#
# Get Config
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ì„¤ì • íŒŒì¼(config.json)ì„ ì½ì–´ì™€ì„œ í”„ë¡œê·¸ë¨ì˜ ë™ì‘ì„ ì œì–´í•©ë‹ˆë‹¤.
# ì„¤ì • íŒŒì¼ì—ëŠ” ê´€ì‹¬ ì¢…ëª©, ë‰´ìŠ¤ í‚¤ì›Œë“œ, ìœ íŠœë¸Œ ì±„ë„, ì´ë©”ì¼ ìˆ˜ì‹ ì ëª©ë¡ ë“±ì´ í¬í•¨ë©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

def load_config():
    """
    config.json íŒŒì¼ì„ ì½ì–´ì™€ì„œ ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
    
    [ì„¤ì • íŒŒì¼ êµ¬ì¡°]
    - stock_tickers: ê´€ì‹¬ ì£¼ì‹ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (ì˜ˆ: ["AAPL", "TSLA", "NVDA"])
    - news_keywords: ë‰´ìŠ¤ ê²€ìƒ‰ í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸
    - youtube_channels: ìœ íŠœë¸Œ ì±„ë„ ID ë”•ì…”ë„ˆë¦¬ (ì±„ë„ëª…: ì±„ë„ID)
    - youtube_keywords: ìœ íŠœë¸Œ íŠ¸ë Œë“œ ê²€ìƒ‰ í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸
    - email_recipients: ì´ë©”ì¼ ìˆ˜ì‹ ì ëª©ë¡
    
    Returns:
        dict: ì„¤ì • ë°ì´í„° ë˜ëŠ” íŒŒì¼ì´ ì—†ìœ¼ë©´ None
    """
    # ì„¤ì • íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ None ë°˜í™˜
    if not os.path.exists('config.json'): return None
    
    # UTF-8 ì¸ì½”ë”©ìœ¼ë¡œ íŒŒì¼ì„ ì—´ì–´ JSON íŒŒì‹±
    with open('config.json', 'r', encoding='utf-8') as f:
        return json.load(f)



# -----------------------------------------------------------------------------------------------------------------------------#
# --- ê³µí†µ ìœ í‹¸: ìë§‰ ì¶”ì¶œ (íƒ€ì„ìŠ¤íƒ¬í”„) ---
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ìœ íŠœë¸Œ ì˜ìƒì˜ ìë§‰(transcript)ì„ íƒ€ì„ìŠ¤íƒ¬í”„ì™€ í•¨ê»˜ ì¶”ì¶œí•©ë‹ˆë‹¤.
# ì¶”ì¶œëœ ìë§‰ì€ AI ë¶„ì„ì˜ ì£¼ìš” ì…ë ¥ ë°ì´í„°ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
# ìë§‰ì´ ì—†ëŠ” ì˜ìƒì˜ ê²½ìš° Noneì„ ë°˜í™˜í•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

def get_timed_transcript(video_id):
    """
    ìœ íŠœë¸Œ ì˜ìƒì—ì„œ ìë§‰ì„ ì¶”ì¶œí•˜ê³  íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ë¶™ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
    
    Args:
        video_id (str): ìœ íŠœë¸Œ ì˜ìƒ ID (ì˜ˆ: "dQw4w9WgXcQ")
    
    Returns:
        str: íƒ€ì„ìŠ¤íƒ¬í”„ê°€ í¬í•¨ëœ ìë§‰ í…ìŠ¤íŠ¸
             í˜•ì‹: "[MM:SS] ìë§‰ë‚´ìš©\\n[MM:SS] ìë§‰ë‚´ìš©\\n..."
             ìë§‰ì´ ì—†ìœ¼ë©´ None ë°˜í™˜
    
    [ì§€ì› ì–¸ì–´ ìš°ì„ ìˆœìœ„]
    1. í•œêµ­ì–´ (ko)
    2. í•œêµ­ì–´ ë³€í˜• (ko-KR)
    3. ì˜ì–´ (en)
    4. ìë™ ìƒì„± (auto)
    """
    try:
        # ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì‚¬ìš© ê°€ëŠ¥í•œ ìë§‰ ì–¸ì–´ë¡œ ìë§‰ ê°€ì ¸ì˜¤ê¸°
        transcript  = YouTubeTranscriptApi.get_transcript(video_id, languages=['ko', 'ko-KR', 'en', 'auto'])
        script_data = ""

        # ê° ìë§‰ ì—”íŠ¸ë¦¬ë¥¼ ìˆœíšŒí•˜ë©° íƒ€ì„ìŠ¤íƒ¬í”„ í¬ë§·íŒ…
        for entry in transcript:
            # ì‹œì‘ ì‹œê°„(ì´ˆ)ì„ MM:SS í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            # ì˜ˆ: 125ì´ˆ -> [02:05]
            time_str = f"[{int(entry['start'])//60:02d}:{int(entry['start'])%60:02d}]"
            script_data += f"{time_str} {entry['text']}\n"

        return script_data

    except: 
        # ìë§‰ì´ ì—†ê±°ë‚˜ ì ‘ê·¼ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° None ë°˜í™˜
        # (ìë™ ìƒì„± ìë§‰ë„ ì—†ëŠ” ì˜ìƒ, ìë§‰ ë¹„í™œì„±í™” ì˜ìƒ ë“±)
        return None



# -----------------------------------------------------------------------------------------------------------------------------#
# --- 1. ë‰´ìŠ¤ ìˆ˜ì§‘ (24ì‹œê°„ & ë©”ì´ì €) ---
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” Google News RSS í”¼ë“œë¥¼ í†µí•´ ìµœê·¼ 24ì‹œê°„ ì´ë‚´ì˜ ë‰´ìŠ¤ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
# ë¯¸êµ­ ì£¼ìš” ì–¸ë¡ ì‚¬(Reuters, Bloomberg, CNBC ë“±)ì˜ ë‰´ìŠ¤ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
# RSSì—ì„œ ì œê³µí•˜ëŠ” ë§í¬ë¥¼ í†µí•´ ì‹¤ì œ ê¸°ì‚¬ ë³¸ë¬¸ë„ ì¶”ì¶œí•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

def fetch_news_raw(keywords, limit=2):
    """
    Google News RSSì—ì„œ í‚¤ì›Œë“œ ê¸°ë°˜ìœ¼ë¡œ ë‰´ìŠ¤ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
    
    Args:
        keywords (list): ê²€ìƒ‰í•  í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ (ì˜ˆ: ["AAPL stock", "Tesla news"])
        limit (int): í‚¤ì›Œë“œë‹¹ ìˆ˜ì§‘í•  ìµœëŒ€ ë‰´ìŠ¤ ê°œìˆ˜ (ê¸°ë³¸ê°’: 2)
    
    Returns:
        list: ë‰´ìŠ¤ ë°ì´í„° ë”•ì…”ë„ˆë¦¬ ë¦¬ìŠ¤íŠ¸
              ê° í•­ëª©: {'query', 'title', 'url', 'content'}
    
    [ë™ì‘ íë¦„]
    1. ê° í‚¤ì›Œë“œì— ëŒ€í•´ Google News RSS URL ìƒì„±
    2. 'when:1d' íŒŒë¼ë¯¸í„°ë¡œ 24ì‹œê°„ ì´ë‚´ ë‰´ìŠ¤ë§Œ í•„í„°ë§
    3. ê° ë‰´ìŠ¤ ë§í¬ì—ì„œ trafilaturaë¡œ ë³¸ë¬¸ ì¶”ì¶œ
    4. ë³¸ë¬¸ì´ 50ì ë¯¸ë§Œì´ë©´ ìŠ¤í‚µ (ê´‘ê³ /ìŠ¤ë‹ˆí« ì œì™¸)
    """
    print(f"ğŸ“° í•´ì™¸ ë©”ì´ì € ë‰´ìŠ¤ ìˆ˜ì§‘ ì¤‘...")
    news_data = []
    # User-Agent í—¤ë”: ë´‡ ì°¨ë‹¨ ë°©ì§€ë¥¼ ìœ„í•´ ì¼ë°˜ ë¸Œë¼ìš°ì €ë¡œ ìœ„ì¥
    headers   = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'}

    for keyword in keywords:
        try:
            # í‚¤ì›Œë“œë¥¼ URL ì•ˆì „ í˜•ì‹ìœ¼ë¡œ ì¸ì½”ë”© (ê³µë°± -> %20 ë“±)
            encoded = urllib.parse.quote(keyword)
            # Google News RSS URL êµ¬ì„±
            # - when:1d: ìµœê·¼ 24ì‹œê°„ ì´ë‚´ ë‰´ìŠ¤ë§Œ
            # - hl=en-US, gl=US: ë¯¸êµ­íŒ ë‰´ìŠ¤ (ë©”ì´ì € ì™¸ì‹  ìš°ì„ )
            # hl=en-US, gl=US -> ë¯¸êµ­íŒ ë‰´ìŠ¤ (ë©”ì´ì € ì™¸ì‹  ìš°ì„ )
            url = f"https://news.google.com/rss/search?q={encoded}+when:1d&hl=en-US&gl=US&ceid=US:en"
            
            # feedparserë¡œ RSS í”¼ë“œ íŒŒì‹±
            feed  = feedparser.parse(url)
            count = 0

            # RSS í”¼ë“œì˜ ê° ë‰´ìŠ¤ í•­ëª© ìˆœíšŒ
            for entry in feed.entries:
                # í‚¤ì›Œë“œë‹¹ limit ê°œìˆ˜ê¹Œì§€ë§Œ ìˆ˜ì§‘
                if count >= limit: break
                
                # ê¸°ì‚¬ ë³¸ë¬¸ ì¶”ì¶œ ì‹œë„
                content = ""
                try:
                    # ë‰´ìŠ¤ ì›ë³¸ í˜ì´ì§€ì— HTTP ìš”ì²­ (3ì´ˆ íƒ€ì„ì•„ì›ƒ)
                    res     = requests.get(entry.link, headers=headers, timeout=3)
                    # trafilaturaë¡œ HTMLì—ì„œ ë³¸ë¬¸ë§Œ ì¶”ì¶œ
                    content = trafilatura.extract(res.text)
                except: pass  # ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ë¹ˆ ë¬¸ìì—´ë¡œ ì§„í–‰
                
                # ë³¸ë¬¸ì´ ìˆìœ¼ë©´ ë³¸ë¬¸ ì‚¬ìš©, ì—†ìœ¼ë©´ RSSì˜ description ì‚¬ìš©
                raw_text = content if content else entry.description
                # ë‚´ìš©ì´ ì—†ê±°ë‚˜ 50ì ë¯¸ë§Œì´ë©´ ìŠ¤í‚µ (ê´‘ê³ /ì§§ì€ ìŠ¤ë‹ˆí« ì œì™¸)
                if not raw_text or len(raw_text) < 50: continue
                
                # í…ìŠ¤íŠ¸ ì •ì œ ë° 4000ì ì œí•œ (AI ì…ë ¥ í¬ê¸° ê´€ë¦¬)
                clean_text = trafilatura.utils.sanitize(raw_text)[:4000]
                
                # ìˆ˜ì§‘ëœ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                news_data.append({
                    'query'   : keyword,     # ê²€ìƒ‰ì— ì‚¬ìš©ëœ í‚¤ì›Œë“œ
                    'title'   : entry.title, # ë‰´ìŠ¤ ì œëª©
                    'url'     : entry.link,  # ì›ë³¸ ê¸°ì‚¬ URL
                    'content' : clean_text   # ì •ì œëœ ë³¸ë¬¸ ë‚´ìš©
                })
                count += 1
            print(f"  - [{keyword}] {count}ê±´ í™•ë³´")

        except: pass  # íŠ¹ì • í‚¤ì›Œë“œ ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ í‚¤ì›Œë“œë¡œ ê³„ì† ì§„í–‰

    return news_data


# -----------------------------------------------------------------------------------------------------------------------------#
# 1. Market Status Check (ì‚¬ìš©ì ìš”ì²­ ë¡œì§ ë³µì›)
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ë¯¸êµ­ ì¦ì‹œ(NYSE)ê°€ ì˜¤ëŠ˜ ê°œì¥ì¼ì¸ì§€ íœ´ì¥ì¼ì¸ì§€ íŒë‹¨í•©ë‹ˆë‹¤.
# ì£¼ë§ê³¼ ê³µíœ´ì¼(í¬ë¦¬ìŠ¤ë§ˆìŠ¤, ë…ë¦½ê¸°ë…ì¼ ë“±)ì„ ì •í™•í•˜ê²Œ íŒë³„í•˜ê¸° ìœ„í•´
# pandas_market_calendars ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
# íœ´ì¥ì¼ì—ëŠ” ì£¼ê°€ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì§€ ì•Šê³ , ë‰´ìŠ¤ ìœ„ì£¼ë¡œ ë¸Œë¦¬í•‘ì„ ì§„í–‰í•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

def check_market_status():
    """
    pandas_market_calendarsë¥¼ ì´ìš©í•˜ì—¬ ì •ë°€í•˜ê²Œ íœ´ì¥ì¼ì„ íŒë‹¨í•©ë‹ˆë‹¤.
    
    Returns:
        bool: True = ê°œì¥ì¼ (ì£¼ê°€ ë°ì´í„° ìˆ˜ì§‘ ê°€ëŠ¥)
              False = íœ´ì¥ì¼ (ì£¼ë§/ê³µíœ´ì¼)
    
    [ë™ì‘ íë¦„]
    1. NYSE ìº˜ë¦°ë” ë¡œë“œ
    2. í˜„ì¬ ì‹œê°„ì„ ë‰´ìš• ì‹œê°„ìœ¼ë¡œ ë³€í™˜
    3. ì˜¤ëŠ˜ ë‚ ì§œê°€ ê±°ë˜ ìŠ¤ì¼€ì¤„ì— ìˆëŠ”ì§€ í™•ì¸
    4. ìŠ¤ì¼€ì¤„ì´ ë¹„ì–´ìˆìœ¼ë©´ íœ´ì¥ì¼
    """
    try:
        # [Step 1] NYSE(ë‰´ìš•ì¦ê¶Œê±°ë˜ì†Œ) ë‹¬ë ¥ ë¡œë“œ
        # NYSE ìº˜ë¦°ë”ì—ëŠ” ëª¨ë“  ê³µíœ´ì¼ ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
        nyse         = mcal.get_calendar('NYSE')
        
        # [Step 2] í˜„ì¬ ì‹œê°„ì„ ë‰´ìš• ì‹œê°„(US/Eastern)ìœ¼ë¡œ ë³€í™˜
        # í•œêµ­ ì‹œê°„ ê¸°ì¤€ì´ ì•„ë‹Œ ë‰´ìš• í˜„ì§€ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨í•´ì•¼ í•©ë‹ˆë‹¤.
        now_utc      = datetime.now(pytz.utc)           # í˜„ì¬ UTC ì‹œê°„
        ny_tz        = pytz.timezone('US/Eastern')      # ë‰´ìš• íƒ€ì„ì¡´ ê°ì²´
        now_ny       = now_utc.astimezone(ny_tz)        # UTC -> ë‰´ìš• ì‹œê°„ ë³€í™˜
        current_date = now_ny.date()                    # ë‚ ì§œë§Œ ì¶”ì¶œ
        
        # [Step 3] ì˜¤ëŠ˜ ë‚ ì§œê°€ ìŠ¤ì¼€ì¤„ì— ìˆëŠ”ì§€ í™•ì¸
        # schedule() ë©”ì„œë“œëŠ” í•´ë‹¹ ë‚ ì§œ ë²”ìœ„ì˜ ê±°ë˜ ì‹œê°„ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
        schedule     = nyse.schedule(start_date=current_date, end_date=current_date)
        
        # [Step 4] ìŠ¤ì¼€ì¤„ì´ ë¹„ì–´ìˆìœ¼ë©´(Empty) íœ´ì¥ì¼(ì£¼ë§/ê³µíœ´ì¼)
        if schedule.empty:
            print(f"â›” [Market Check] ë¯¸ ì¦ì‹œ íœ´ì¥ì¼ì…ë‹ˆë‹¤. (NY Date: {current_date})")
            return False
            
        print(f"âœ… [Market Check] ë¯¸ ì¦ì‹œ ê°œì¥ì¼ì…ë‹ˆë‹¤. (NY Date: {current_date})")
        return True
        
    except Exception as e:
        # [í´ë°±] ìº˜ë¦°ë” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—ëŸ¬ ë°œìƒ ì‹œ yfinanceë¡œ 2ì°¨ í™•ì¸
        # SPY ETFì˜ ë‹¹ì¼ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ë¡œ ê°œì¥ ì—¬ë¶€ íŒë‹¨
        print(f"âš ï¸ ë§ˆì¼“ ìº˜ë¦°ë” í™•ì¸ ì¤‘ ì—ëŸ¬: {e}")
        # ì—ëŸ¬ ë°œìƒ ì‹œ ë³´ìˆ˜ì ìœ¼ë¡œ yfinance ë°ì´í„° ìœ ë¬´ë¡œ 2ì°¨ í™•ì¸
        try:
            spy = yf.Ticker("SPY")  # S&P 500 ì¶”ì¢… ETF
            # ë‹¹ì¼ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê°œì¥, ì—†ìœ¼ë©´ íœ´ì¥
            return not spy.history(period="1d").empty
        except:
            return False  # ëª¨ë“  í™•ì¸ ì‹¤íŒ¨ ì‹œ íœ´ì¥ìœ¼ë¡œ ê°„ì£¼


# -----------------------------------------------------------------------------------------------------------------------------#
# 2. Data Collection (ê²½ì œ ì§€í‘œ ê²€ìƒ‰ ì¶”ê°€ & í¬ë§· ê³ ì •)
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ì„¤ì •ëœ ì¢…ëª©ë“¤ì˜ ì‹¤ì‹œê°„ ì£¼ê°€ ë°ì´í„°ë¥¼ Yahoo Financeì—ì„œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
# ê° ì¢…ëª©ë³„ë¡œ í˜„ì¬ê°€, ì „ì¼ ëŒ€ë¹„ ë³€ë™ëŸ‰, ë³€ë™ë¥ ì„ ê³„ì‚°í•˜ê³ 
# ê´€ë ¨ ë‰´ìŠ¤ë„ í•¨ê»˜ ìˆ˜ì§‘í•˜ì—¬ AI ë¶„ì„ì— í™œìš©í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

def collect_stock_data(tickers):
    """
    Yahoo Financeì—ì„œ ì£¼ì‹ ì‹œì„¸ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ë³‘í•©í•©ë‹ˆë‹¤.
    
    Args:
        tickers (list): ì£¼ì‹ ì¢…ëª© ì‹¬ë³¼ ë¦¬ìŠ¤íŠ¸ (ì˜ˆ: ["AAPL", "TSLA", "NVDA"])
    
    Returns:
        list: ì£¼ì‹ ë°ì´í„° ë”•ì…”ë„ˆë¦¬ ë¦¬ìŠ¤íŠ¸
              ê° í•­ëª©: {'symbol', 'price', 'change_str', 'news_items'}
    
    [ë°ì´í„° í˜•ì‹]
    - price: í˜„ì¬ê°€ (ì˜ˆ: "$150.25")
    - change_str: ì „ì¼ ëŒ€ë¹„ ë³€ë™ (ì˜ˆ: "+2.50 (+1.69%)")
    """
    print("ğŸ“ˆ ì£¼ì‹ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
    stock_data     = []
    # ê°œì¥ì¼ì¸ì§€ ë¨¼ì € í™•ì¸ (íœ´ì¥ì¼ì´ë©´ ì‹œì„¸ ì¡°íšŒ ìŠ¤í‚µ)
    is_market_open = check_market_status()

    for symbol in tickers:
        try:
            # [Step 1] í•´ë‹¹ ì¢…ëª© ê´€ë ¨ ë‰´ìŠ¤ ìˆ˜ì§‘ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            # ì¢…ëª©ëª…ìœ¼ë¡œ ë‰´ìŠ¤ ê²€ìƒ‰í•˜ì—¬ AI ë¶„ì„ ìë£Œë¡œ í™œìš©
            related_news = fetch_news_raw([f"{symbol} stock news", f"{symbol} analysis"], limit=2)
            
            # [Step 2] ê°œì¥ì¼ì—ë§Œ ì‹¤ì‹œê°„ ì‹œì„¸ ì¡°íšŒ
            if is_market_open:
                # yfinance Ticker ê°ì²´ ìƒì„±
                ticker = yf.Ticker(symbol)
                # ìµœê·¼ 5ê±°ë˜ì¼ ë°ì´í„° ì¡°íšŒ (ì „ì¼ ëŒ€ë¹„ ê³„ì‚°ì„ ìœ„í•´)
                h = ticker.history(period="5d")
                
                # ìµœì†Œ 2ì¼ì¹˜ ë°ì´í„°ê°€ ìˆì–´ì•¼ ì „ì¼ ëŒ€ë¹„ ê³„ì‚° ê°€ëŠ¥
                if len(h) >= 2:
                    last       = h['Close'].iloc[-1]   # ìµœê·¼ ì¢…ê°€ (ì˜¤ëŠ˜ ë˜ëŠ” ê°€ì¥ ìµœì‹ )
                    prev       = h['Close'].iloc[-2]   # ì „ì¼ ì¢…ê°€
                    diff       = last - prev           # ë“±ë½í­ (ë‹¬ëŸ¬)
                    pct        = (diff / prev) * 100   # ë“±ë½ë¥  (%)
                    
                    # ê°€ê²© í¬ë§·íŒ…: ë‹¬ëŸ¬ ê¸°í˜¸ + ì†Œìˆ˜ì  2ìë¦¬
                    price_str  = f"${last:.2f}"
                    # [ìš”ì²­] ì¦ê°ëŸ‰ (ì¦ê°ë¥ ) í¬ë§·: -15.55 (-3.27%)
                    # +/- ë¶€í˜¸ ìë™ í¬í•¨ë˜ë„ë¡ :+.2f í¬ë§· ì‚¬ìš©
                    change_str = f"{diff:+.2f} ({pct:+.2f}%)"
                else:
                    # ë°ì´í„° ë¶€ì¡± ì‹œ N/A í‘œì‹œ
                    price_str  = "N/A"
                    change_str = "0.00 (0.00%)"
            else:
                # íœ´ì¥ì¼ì—ëŠ” ì‹œì„¸ ëŒ€ì‹  "Market Closed" í‘œì‹œ
                price_str  = "N/A"
                change_str = "Market Closed"

            # ìˆ˜ì§‘ëœ ë°ì´í„°ë¥¼ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
            stock_data.append({
                'symbol'     : symbol,       # ì¢…ëª© ì‹¬ë³¼ (ì˜ˆ: AAPL)
                'price'      : price_str,    # í˜„ì¬ê°€ ë¬¸ìì—´
                'change_str' : change_str,   # ë³€ë™ ë¬¸ìì—´
                'news_items' : related_news  # ê´€ë ¨ ë‰´ìŠ¤ ë¦¬ìŠ¤íŠ¸
            })
            print(f"  - [{symbol}] {price_str} / {change_str}")
        except:
            # ê°œë³„ ì¢…ëª© ì˜¤ë¥˜ ì‹œ ìŠ¤í‚µí•˜ê³  ë‹¤ìŒ ì¢…ëª© ì²˜ë¦¬
            pass
    return stock_data


# -----------------------------------------------------------------------------------------------------------------------------#
# [ì‹ ê·œ] ê³µí¬/íƒìš• ì§€ìˆ˜ ì‹¤ì‹œê°„ í¬ë¡¤ë§ (Selenium)
# -----------------------------------------------------------------------------------------------------------------------------#
# CNN Fear & Greed IndexëŠ” JavaScriptë¡œ ë Œë”ë§ë˜ëŠ” ë™ì  í˜ì´ì§€ì…ë‹ˆë‹¤.
# ì¼ë°˜ HTTP ìš”ì²­ìœ¼ë¡œëŠ” ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ Selenium í—¤ë“œë¦¬ìŠ¤ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
# Docker í™˜ê²½ì—ì„œ Chromiumì„ ì‚¬ìš©í•˜ë©°, ì°¨ë‹¨ ë°©ì§€ë¥¼ ìœ„í•´ User-Agentë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
# ê³µí¬íƒìš•ì§€ìˆ˜ëŠ” ì‹œì¥ ì‹¬ë¦¬ë¥¼ 0~100 ì‚¬ì´ ìˆ«ìë¡œ í‘œí˜„í•©ë‹ˆë‹¤. (0=ê·¹ë„ì˜ ê³µí¬, 100=ê·¹ë„ì˜ íƒìš•)
# -----------------------------------------------------------------------------------------------------------------------------#

def fetch_fear_greed_index():
    """
    CNN Fear & Greed Index í˜ì´ì§€ì—ì„œ ì‹¤ì‹œê°„ ê³µí¬íƒìš•ì§€ìˆ˜ë¥¼ í¬ë¡¤ë§í•©ë‹ˆë‹¤.
    
    Returns:
        str: í˜ì´ì§€ ìƒë‹¨ í…ìŠ¤íŠ¸ (ìµœëŒ€ 2000ì) - AIê°€ ë¶„ì„í•  ì›ë³¸ ë°ì´í„°
             ì‹¤íŒ¨ ì‹œ None ë°˜í™˜
    
    [ë™ì‘ íë¦„]
    1. Headless Chrome ë¸Œë¼ìš°ì € ì„¤ì • (Docker í™˜ê²½ ìµœì í™”)
    2. CNN Fear & Greed í˜ì´ì§€ ì ‘ì†
    3. JavaScript ë Œë”ë§ ëŒ€ê¸° (5ì´ˆ)
    4. body íƒœê·¸ì˜ í…ìŠ¤íŠ¸ ì „ì²´ ì¶”ì¶œ
    5. ìƒë‹¨ 2000ìë§Œ ë°˜í™˜ (ì§€ìˆ˜ëŠ” ë³´í†µ ìƒë‹¨ì— ìœ„ì¹˜)
    """
    print("ğŸ§  Fear & Greed Index ì§ì ‘ ì ‘ì† ì‹œë„ (CNN)...")
    driver = None  # ì—ëŸ¬ ë°œìƒ ì‹œ ì •ë¦¬ë¥¼ ìœ„í•´ ë¯¸ë¦¬ ì„ ì–¸
    try:
        # [Step 1] Chrome ì˜µì…˜ ì„¤ì • (Docker í™˜ê²½ì— ë§ê²Œ ìµœì í™”)
        # video_studio ëª¨ë“ˆê³¼ ë™ì¼í•œ ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        chrome_options = Options()
        chrome_options.binary_location = "/usr/bin/chromium"  # Docker ë‚´ Chromium ê²½ë¡œ
        chrome_options.add_argument('--headless=new')          # í—¤ë“œë¦¬ìŠ¤ ëª¨ë“œ (í™”ë©´ ì—†ì´ ì‹¤í–‰)
        chrome_options.add_argument('--no-sandbox')            # ìƒŒë“œë°•ìŠ¤ ë¹„í™œì„±í™” (Docker í•„ìˆ˜)
        chrome_options.add_argument('--disable-dev-shm-usage') # ê³µìœ  ë©”ëª¨ë¦¬ ì´ìŠˆ ë°©ì§€
        chrome_options.add_argument('--disable-gpu')           # GPU ê°€ì† ë¹„í™œì„±í™”
        
        # [Step 2] User-Agent ì„¤ì • (ì°¨ë‹¨ ë°©ì§€)
        # ë´‡ìœ¼ë¡œ ê°ì§€ë˜ë©´ ì°¨ë‹¨ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¼ë°˜ ë¸Œë¼ìš°ì €ë¡œ ìœ„ì¥
        user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
        chrome_options.add_argument(f'user-agent={user_agent}')

        # [Step 3] WebDriver ì´ˆê¸°í™”
        # Docker í™˜ê²½ì—ì„œëŠ” chromedriver ê²½ë¡œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •
        if os.path.exists("/usr/bin/chromedriver"):
            service = ChromeService(executable_path="/usr/bin/chromedriver")
            driver = webdriver.Chrome(service=service, options=chrome_options)
        else:
            # ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œëŠ” ìë™ ê°ì§€
            driver = webdriver.Chrome(options=chrome_options)

        # [Step 4] CNN ê³µí¬ì§€ìˆ˜ í˜ì´ì§€ ì ‘ì†
        driver.set_page_load_timeout(30)  # í˜ì´ì§€ ë¡œë”© íƒ€ì„ì•„ì›ƒ 30ì´ˆ
        driver.get("https://www.cnn.com/markets/fear-and-greed")
        
        # [Step 5] í˜ì´ì§€ ë¡œë”© ëŒ€ê¸° (ë°ì´í„°ê°€ ëœ° ë•Œê¹Œì§€)
        # JavaScriptë¡œ ë™ì  ë Œë”ë§ë˜ë¯€ë¡œ ì¶©ë¶„í•œ ëŒ€ê¸° ì‹œê°„ í•„ìš”
        time.sleep(5) 
        
        # [Step 6] í˜ì´ì§€ ì „ì²´ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        # íŠ¹ì • í´ë˜ìŠ¤ë¥¼ ì°¾ê¸°ë³´ë‹¤, í™”ë©´ì— ë³´ì´ëŠ” í…ìŠ¤íŠ¸ë¥¼ í†µì§¸ë¡œ ê°€ì ¸ì™€ì„œ 
        # AIì—ê²Œ ë¶„ì„ì‹œí‚¤ëŠ” ê²ƒì´ ê°€ì¥ í™•ì‹¤í•©ë‹ˆë‹¤. (ì‚¬ì´íŠ¸ êµ¬ì¡° ë³€ê²½ì— ê°•ê±´)
        body_text = driver.find_element(By.TAG_NAME, 'body').text
        
        # [Step 7] ê²°ê³¼ ê²€ì¦ ë° ë°˜í™˜
        # ë„ˆë¬´ ê¸¸ë©´ ì•ë¶€ë¶„ë§Œ ìë¥´ê¸° (ì§€ìˆ˜ëŠ” ë³´í†µ ìƒë‹¨ì— ìˆìŒ)
        # "Fear & Greed Index" í‚¤ì›Œë“œ ì£¼ë³€ í…ìŠ¤íŠ¸ë¥¼ í™•ë³´
        if "Fear & Greed Index" in body_text:
            print("   âœ… ê³µí¬ì§€ìˆ˜ í˜ì´ì§€ ë°ì´í„° í™•ë³´ ì„±ê³µ")
            return body_text[:2000]  # ìƒë‹¨ 2000ìë§Œ ë°˜í™˜ (ì¶©ë¶„í•¨)
        else:
            print("   âš ï¸ í˜ì´ì§€ í…ìŠ¤íŠ¸ì—ì„œ 'Fear & Greed Index'ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
            return None

    except Exception as e:
        print(f"   âš ï¸ í¬ë¡¤ë§ ì—ëŸ¬: {e}")
        return None
    finally:
        # [ì •ë¦¬] ë¸Œë¼ìš°ì € ë¦¬ì†ŒìŠ¤ í•´ì œ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
        if driver:
            try: driver.quit()
            except: pass


# -----------------------------------------------------------------------------------------------------------------------------#
# 2. Data Collection (ìˆ˜ì •ë¨: ê³µí¬ì§€ìˆ˜ í¬ë¡¤ë§ í†µí•©)
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ê²½ì œ ì§€í‘œ ë° ì¼ì • ê´€ë ¨ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
# 1) ë‰´ìŠ¤ ê²€ìƒ‰ìœ¼ë¡œ ê²½ì œ ì¼ì •ê³¼ ì„¹í„° ë™í–¥ ìˆ˜ì§‘
# 2) Seleniumìœ¼ë¡œ CNN ê³µí¬íƒìš•ì§€ìˆ˜ ì§ì ‘ í¬ë¡¤ë§
# ë‘ ë°ì´í„°ë¥¼ í•©ì³ì„œ AI ë¶„ì„ì— ì œê³µí•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

def collect_economy_data():
    """
    ê²½ì œ ì§€í‘œ, ì¼ì •, ê³µí¬íƒìš•ì§€ìˆ˜ ë“± ê±°ì‹œê²½ì œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
    
    Returns:
        list: ê²½ì œ ê´€ë ¨ ë‰´ìŠ¤/ë°ì´í„° ë”•ì…”ë„ˆë¦¬ ë¦¬ìŠ¤íŠ¸
              ê³µí¬ì§€ìˆ˜ í¬ë¡¤ë§ ê²°ê³¼ë„ ë‰´ìŠ¤ í˜•íƒœë¡œ í¬í•¨ë¨
    
    [ìˆ˜ì§‘ í•­ëª©]
    1. ì´ë²ˆ ì£¼ ì£¼ìš” ê²½ì œ ì¼ì • (CPI, FOMC ë“±)
    2. ë¯¸êµ­ ì£¼ì‹ ì‹œì¥ ì„¹í„°ë³„ ì„±ê³¼
    3. CNN Fear & Greed Index (ì‹¤ì‹œê°„ í¬ë¡¤ë§)
    """
    print("ğŸŒ ê²½ì œ ì§€í‘œ ë° ì¼ì • ê²€ìƒ‰ ì¤‘...")
    
    # [Step 1] ê¸°ì¡´ ë‰´ìŠ¤ ê²€ìƒ‰ (ê²½ì œ ì¼ì •, ì„¹í„° ë™í–¥ìš©)
    queries = [
        "Major US Economic Calendar events this week",  # ê²½ì œ ì¼ì • (CPI, ê³ ìš©ì§€í‘œ ë“±)
        "US Stock Market Sector Performance today"      # ì„¹í„°ë³„ ì„±ê³¼ (ê¸°ìˆ ì£¼, ì—ë„ˆì§€ ë“±)
    ]
    news_results = fetch_news_raw(queries, limit=5)
    
    # [Step 2] ê³µí¬ì§€ìˆ˜ ì§ì ‘ í¬ë¡¤ë§ ê²°ê³¼ í•©ì¹˜ê¸°
    # CNN í˜ì´ì§€ì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì§€ìˆ˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    fg_text = fetch_fear_greed_index()
    if fg_text:
        # AIê°€ ì½ì„ ìˆ˜ ìˆëŠ” ë‰´ìŠ¤ í˜•íƒœì˜ ë”•ì…”ë„ˆë¦¬ë¡œ í¬ì¥í•´ì„œ ì¶”ê°€
        # ë‹¤ë¥¸ ë‰´ìŠ¤ì™€ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ ë§Œë“¤ì–´ì•¼ AIê°€ ì¼ê´€ë˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        news_results.append({
            'query': 'Fear & Greed Index Direct Crawl',
            'title': 'Real-time Fear & Greed Index Data from CNN',
            'url': 'https://www.cnn.com/markets/fear-and-greed',
            'content': f"[SYSTEM DATA] This is the raw text scraped from CNN Fear & Greed page:\n\n{fg_text}"
        })
    else:
        # [í´ë°±] í¬ë¡¤ë§ ì‹¤íŒ¨ ì‹œ ê²€ìƒ‰ìœ¼ë¡œë¼ë„ ì‹œë„ (ë°±ì—…)
        # ì •í™•ë„ëŠ” ë–¨ì–´ì§€ì§€ë§Œ ì—†ëŠ” ê²ƒë³´ë‹¤ ë‚˜ìŒ
        fallback = fetch_news_raw(["CNN Fear and Greed Index current score"], limit=1)
        news_results.extend(fallback)
        
    return news_results


# -----------------------------------------------------------------------------------------------------------------------------#
# --- 3. ì±„ë„ ê¸°ë°˜ ìœ íŠœë¸Œ ìˆ˜ì§‘ (24ì‹œê°„ ì´ë‚´) ---
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ì„¤ì •ëœ ìœ íŠœë¸Œ ì±„ë„ë“¤ì—ì„œ ìµœê·¼ 24ì‹œê°„ ì´ë‚´ì— ì—…ë¡œë“œëœ ì˜ìƒì„ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
# ê° ì±„ë„ì˜ ìµœì‹  ì—…ë¡œë“œ ì¬ìƒëª©ë¡ì—ì„œ ì˜ìƒì„ ê°€ì ¸ì˜¤ê³ , ìë§‰ì„ ì¶”ì¶œí•˜ì—¬ AI ë¶„ì„ì— í™œìš©í•©ë‹ˆë‹¤.
# ì±„ë„ë³„ë¡œ 1ê°œì˜ ì˜ìƒë§Œ ìˆ˜ì§‘í•©ë‹ˆë‹¤ (ë„ˆë¬´ ë§ì€ ë°ì´í„° ë°©ì§€).
# -----------------------------------------------------------------------------------------------------------------------------#

def collect_channel_youtube_data(channels_dict):
    """
    ì„¤ì •ëœ ìœ íŠœë¸Œ ì±„ë„ë“¤ì—ì„œ ìµœê·¼ 24ì‹œê°„ ì´ë‚´ ì˜ìƒì„ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
    
    Args:
        channels_dict (dict): ì±„ë„ ì •ë³´ ë”•ì…”ë„ˆë¦¬ {ì±„ë„ëª…: ì±„ë„ID}
                              ì˜ˆ: {"ì‚¼í”„ë¡œTV": "UCxxx...", "ê¹€ì‘ê°€TV": "UCyyy..."}
    
    Returns:
        list: ì˜ìƒ ë°ì´í„° ë”•ì…”ë„ˆë¦¬ ë¦¬ìŠ¤íŠ¸
              ê° í•­ëª©: {'type', 'source', 'channel_name', 'title', 'date', 'url', 'content'}
    
    [ë™ì‘ íë¦„]
    1. ê° ì±„ë„ì˜ ì—…ë¡œë“œ ì¬ìƒëª©ë¡ ID ì¡°íšŒ
    2. ì¬ìƒëª©ë¡ì—ì„œ ìµœì‹  ì˜ìƒ 5ê°œ ì¡°íšŒ
    3. 24ì‹œê°„ ì´ë‚´ ì˜ìƒë§Œ í•„í„°ë§
    4. ìë§‰ ì¶”ì¶œ í›„ ë°ì´í„° ì €ì¥
    """
    print("ğŸ¥ ìœ íŠœë¸Œ ì±„ë„ ìˆ˜ì§‘ ì¤‘...")
    # YouTube Data API v3 í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    youtube = build('youtube', 'v3', developerKey=YOUTUBE_API_KEY)
    video_data = []
    now = datetime.utcnow()  # í˜„ì¬ UTC ì‹œê°„ (ìœ íŠœë¸Œ íƒ€ì„ìŠ¤íƒ¬í”„ëŠ” UTC ê¸°ì¤€)

    for name, channel_id in channels_dict.items():
        try:
            # [Step 1] ì±„ë„ì˜ ì—…ë¡œë“œ ì¬ìƒëª©ë¡ ID ì¡°íšŒ
            # ëª¨ë“  ìœ íŠœë¸Œ ì±„ë„ì€ ìë™ìœ¼ë¡œ "uploads" ì¬ìƒëª©ë¡ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.
            res        = youtube.channels().list(id=channel_id, part='contentDetails').execute()
            uploads_id = res['items'][0]['contentDetails']['relatedPlaylists']['uploads']

            # [Step 2] ì—…ë¡œë“œ ì¬ìƒëª©ë¡ì—ì„œ ìµœì‹  ì˜ìƒ 5ê°œ ì¡°íšŒ
            pl_res     = youtube.playlistItems().list(
                playlistId = uploads_id,
                part       = 'snippet',
                maxResults = 5  # ìµœì‹  5ê°œë§Œ ì¡°íšŒ (API í• ë‹¹ëŸ‰ ì ˆì•½)
            ).execute()
            
            # ì˜ìƒì´ ì—†ìœ¼ë©´ ë‹¤ìŒ ì±„ë„ë¡œ
            if not pl_res.get('items'): continue

            for item in pl_res['items']: 
                # ì˜ìƒ ì •ë³´ ì¶”ì¶œ
                vid          = item['snippet']['resourceId']['videoId']  # ì˜ìƒ ê³ ìœ  ID
                title        = item['snippet']['title']                  # ì˜ìƒ ì œëª©
                pub_date_str = item['snippet']['publishedAt']            # ì—…ë¡œë“œ ì‹œê°„ (UTC)
                
                # [Step 3] 24ì‹œê°„ ì´ë‚´ ì˜ìƒë§Œ í•„í„°ë§
                pub_date_dt = datetime.strptime(pub_date_str, "%Y-%m-%dT%H:%M:%SZ")
                if (now - pub_date_dt).total_seconds() > 24 * 3600:
                    continue  # 24ì‹œê°„ ì´ˆê³¼ ì‹œ ìŠ¤í‚µ
                
                # ë‚ ì§œë¥¼ í•œêµ­ ì‹œê°„(KST)ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œìš©ìœ¼ë¡œ ì €ì¥
                pub_date_kst = (pub_date_dt + timedelta(hours=9)).strftime("%Y-%m-%d")
                
                # [Step 4] ìë§‰ ì¶”ì¶œ ì‹œë„
                transcript   = get_timed_transcript(vid)
                # ìë§‰ì´ ìˆìœ¼ë©´ 40000ìê¹Œì§€ ì‚¬ìš©, ì—†ìœ¼ë©´ ì˜ìƒ ì„¤ëª…ìœ¼ë¡œ ëŒ€ì²´
                content      = transcript[:40000] if transcript else f"(ìë§‰ ì—†ìŒ) {item['snippet']['description'][:1000]}"

                # ìˆ˜ì§‘ëœ ì˜ìƒ ë°ì´í„° ì €ì¥
                video_data.append({
                    'type'          : 'channel',       # ìˆ˜ì§‘ ìœ í˜• (ì±„ë„ ê¸°ë°˜)
                    'source'        : name,            # ì†ŒìŠ¤ëª… (ì±„ë„ëª…)
                    'channel_name'  : name,            # [Fix] Page 5ë¥¼ ìœ„í•´ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€
                    'title'         : title,           # ì˜ìƒ ì œëª©
                    'date'          : pub_date_kst,    # ì—…ë¡œë“œ ë‚ ì§œ (KST ê¸°ì¤€)
                    'url'           : f"https://www.youtube.com/watch?v={vid}",  # ì˜ìƒ URL
                    'content'       : content          # ìë§‰ ë˜ëŠ” ì„¤ëª…
                })
                print(f"   - [{name}] í™•ë³´: {title}")
                break  # ì±„ë„ë‹¹ 1ê°œì˜ ì˜ìƒë§Œ ìˆ˜ì§‘ (ìµœì‹  ê²ƒë§Œ)
        except: pass  # ê°œë³„ ì±„ë„ ì˜¤ë¥˜ ì‹œ ë‹¤ìŒ ì±„ë„ë¡œ ê³„ì† ì§„í–‰
        
    return video_data



# -----------------------------------------------------------------------------------------------------------------------------#
# 4. AI í¸ì§‘ì¥: ì£¼ì‹ ë° ë‰´ìŠ¤ ìš”ì•½ (One-Source Multi-Use)
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” í”„ë¡œê·¸ë¨ì˜ í•µì‹¬ìœ¼ë¡œ, ìˆ˜ì§‘ëœ ëª¨ë“  ë°ì´í„°ë¥¼ Gemini AIì—ê²Œ ì „ë‹¬í•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤.
# AIëŠ” ì£¼ì‹ ë“±ë½ ì›ì¸ ë¶„ì„, ë‰´ìŠ¤ ìš”ì•½, ìœ íŠœë¸Œ ì˜ìƒ ìš”ì•½ì„ ìˆ˜í–‰í•˜ê³ 
# ë™ì‹œì— ì˜ìƒ ë‚´ë ˆì´ì…˜ ëŒ€ë³¸ê¹Œì§€ ì‘ì„±í•©ë‹ˆë‹¤ (One-Source Multi-Use ì „ëµ).
# 
# [ì¶œë ¥ ë°ì´í„°]
# 1. stock_details: ê° ì¢…ëª©ì˜ video_summary(ì˜ìƒìš©)ì™€ email_summary(ë©”ì¼ìš©)
# 2. economic_insight: ê³µí¬ì§€ìˆ˜, ê²½ì œ ì¼ì •, ì„¹í„° ë™í–¥
# 3. news_items: ë‰´ìŠ¤ë³„ ìƒì„¸ ìš”ì•½
# 4. youtube_items: ìœ íŠœë¸Œ ì˜ìƒ ìš”ì•½
# 5. scripts: 6ê°œ ì”¬ì˜ ì˜ìƒ ë‚´ë ˆì´ì…˜ ëŒ€ë³¸
# -----------------------------------------------------------------------------------------------------------------------------#

def analyze_and_summarize(stocks, news, youtube, economy_news):
    """
    ìˆ˜ì§‘ëœ ëª¨ë“  ë°ì´í„°ë¥¼ AIë¡œ ë¶„ì„í•˜ê³  ì˜ìƒ ëŒ€ë³¸ì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        stocks (list): ì£¼ì‹ ë°ì´í„° ë¦¬ìŠ¤íŠ¸ (collect_stock_dataì˜ ì¶œë ¥)
        news (list): ë‰´ìŠ¤ ë°ì´í„° ë¦¬ìŠ¤íŠ¸ (fetch_news_rawì˜ ì¶œë ¥)
        youtube (list): ìœ íŠœë¸Œ ì˜ìƒ ë°ì´í„° ë¦¬ìŠ¤íŠ¸
        economy_news (list): ê²½ì œ ì§€í‘œ ë°ì´í„° ë¦¬ìŠ¤íŠ¸ (collect_economy_dataì˜ ì¶œë ¥)
    
    Returns:
        tuple: (stocks, news, youtube, economy_data, generated_scripts)
               - economy_data: AIê°€ ì¶”ì¶œí•œ ê²½ì œ ì¸ì‚¬ì´íŠ¸ ë”•ì…”ë„ˆë¦¬
               - generated_scripts: 6ê°œ ì”¬ì˜ ëŒ€ë³¸ ë”•ì…”ë„ˆë¦¬
    
    [í”„ë¡¬í”„íŠ¸ êµ¬ì¡°]
    - ì§€ì‹œì‚¬í•­ 1: ë°ì´í„° ë¶„ì„ (ì‹œê°í™” ë° ì´ë©”ì¼ìš© ë°ì´í„°)
    - ì§€ì‹œì‚¬í•­ 2: ë°©ì†¡ ëŒ€ë³¸ (6ê°œ ì”¬ì˜ ë‚´ë ˆì´ì…˜)
    
    [ëª¨ë¸ í´ë°± ì „ëµ]
    gemini-2.5-flash â†’ gemini-2.5-pro â†’ gemini-pro ìˆœìœ¼ë¡œ ì‹œë„
    """
    print("ğŸ§  AI í¸ì§‘ì¥: ë°ì´í„° ë¶„ì„ ë° ë°©ì†¡ ëŒ€ë³¸(Script) ì§‘í•„ ì¤‘...")
    
    # ì˜¤ëŠ˜ ë‚ ì§œ í¬ë§· (ëŒ€ë³¸ì—ì„œ "12ì›” 15ì¼ ë°ì¼ë¦¬ ë¸Œë¦¬í•‘ì…ë‹ˆë‹¤" í˜•íƒœë¡œ ì‚¬ìš©)
    # í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ í‘œì‹œ
    kst = pytz.timezone('Asia/Seoul')
    today_date = datetime.now(kst).strftime("%mì›” %dì¼")
    
    # ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¡°ê¸° ë°˜í™˜
    if not stocks and not news and not youtube:
        return stocks, news, youtube


    # [í•µì‹¬ 1] ë°ì´í„° ê²½ëŸ‰í™” (Input Truncation)
    # AI APIì˜ í† í° ì œí•œê³¼ ë¹„ìš©ì„ ê³ ë ¤í•˜ì—¬ ì…ë ¥ ë°ì´í„° í¬ê¸°ë¥¼ ì œí•œí•©ë‹ˆë‹¤.
    # AIê°€ ì²˜ë¦¬í•˜ë‹¤ ë»—ì§€ ì•Šë„ë¡, ë‰´ìŠ¤ ë³¸ë¬¸ì„ 500ìë¡œ ì œí•œí•©ë‹ˆë‹¤.
    clean_news = []
    for n in news[:10]:  # ë‰´ìŠ¤ëŠ” ìµœëŒ€ 10ê°œë§Œ ì „ë‹¬
        clean_n = n.copy()
        if 'content' in clean_n:
            clean_n['content'] = clean_n['content'][:300] + "..."  # 300ì ì œí•œ
        clean_news.append(clean_n)

    # ê²½ì œ ë°ì´í„°ë„ ë§ˆì°¬ê°€ì§€ë¡œ í¬ê¸° ì œí•œ
    clean_economy = []
    for n in economy_news[:3]:  # ê²½ì œ ë°ì´í„°ëŠ” ìµœëŒ€ 3ê°œë§Œ ì „ë‹¬
        clean_n = n.copy()
        if 'content' in clean_n:
            # ê³µí¬ì§€ìˆ˜ í¬ë¡¤ë§ ë°ì´í„° ë“±ì´ ë„ˆë¬´ ê¸¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì œí•œ
            clean_n['content'] = clean_n['content'][:500] + "..." 
        clean_economy.append(clean_n)


    # [ë””ë²„ê·¸ ë¡œê·¸] ì…ë ¥ ë°ì´í„° ìƒíƒœ í™•ì¸
    print(f"ğŸ” [DEBUG] Stocks ê°œìˆ˜: {len(stocks)}")
    print(f"ğŸ” [DEBUG] News ê°œìˆ˜: {len(news)}")
    print(f"ğŸ” [DEBUG] Economy ë°ì´í„° ê¸¸ì´: {len(str(clean_economy))}") 
    if clean_economy:
        print(f"ğŸ” [DEBUG] Economy ë°ì´í„° ìƒ˜í”Œ: {str(clean_economy)[:200]}")

    # [í•µì‹¬ 2] AIì—ê²Œ ì „ë‹¬í•  JSON ë°ì´í„° êµ¬ì„±
    # Raw Data ì¤€ë¹„
    raw_context = json.dumps({
        # ì£¼ì‹ ë°ì´í„°: ì‹¬ë³¼, ê°€ê²©, ë³€ë™ë¥ , ê´€ë ¨ ë‰´ìŠ¤ í¬í•¨
        'stocks'               : [ {'symbol': s['symbol'], 'price': s['price'], 'change': s['change_str'], 'news': s.get('news_items', [])} for s in stocks ], 
        'news'                 : clean_news,        # ì¼ë°˜ ë‰´ìŠ¤
        'youtube'              : youtube[:5],       # ìœ íŠœë¸Œ ì˜ìƒ (ìµœëŒ€ 5ê°œ)
        'economy_search_result': clean_economy      # ê²½ì œ ì§€í‘œ ë°ì´í„°
    }, ensure_ascii=False)  # í•œê¸€ ìœ ì§€
    
    prompt = f"""
    ë‹¹ì‹ ì€ ì›”ê°€(Wall St.)ì˜ ìˆ˜ì„ ì• ë„ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì œê³µëœ ì£¼ì‹/ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ì² ì €íˆ ë¶„ì„í•˜ì—¬ JSONì„ ì‘ì„±í•˜ì„¸ìš”.
    **ì ˆëŒ€ ì—†ëŠ” ì‚¬ì‹¤ì„ ì§€ì–´ë‚´ì§€ ë§ˆì‹­ì‹œì˜¤.**
    **[ê²½ì œ ì§€í‘œ]ì™€ [ì„¹í„° ë™í–¥]ì€ ë°˜ë“œì‹œ 'economy_search_result'ì˜ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ íŒ©íŠ¸ë¥¼ ì°¾ì•„ ê¸°ì…í•˜ì‹­ì‹œì˜¤.**

    [ë°ì´í„°]
    {raw_context}
    
    [ì§€ì‹œì‚¬í•­ 1: ë°ì´í„° ë¶„ì„ (Visual & Email Data)]
    1. stock_details: ë¦¬ìŠ¤íŠ¸ì˜ ëª¨ë“  ì£¼ì‹ì— ëŒ€í•´ ì‘ì„±.
       A. **video_summary (ì˜ìƒ ìë§‰ìš©)**: 
          - ê¸¸ì´: **2ë¬¸ì¥ ë‚´ì™¸(40~60ì)**. 
          - ë‚´ìš©: ë“±ë½ì˜ êµ¬ì²´ì ì¸ ì´ìœ (ë‰´ìŠ¤ ê¸°ë°˜) í¬í•¨. ë‹¨ìˆœ ì‚¬ì‹¤ ë‚˜ì—´ì´ ì•„ë‹ˆë¼ **"ì™œ ì˜¬ëëŠ”ì§€/ë‚´ë ¸ëŠ”ì§€" í•µì‹¬ ì›ì¸**ì„ ë°˜ë“œì‹œ í¬í•¨í•  ê²ƒ.
          - ì˜ˆ: "ì‹¤ì  í˜¸ì¡°ì™€ ì—”ë¹„ë””ì•„ íŒŒíŠ¸ë„ˆì‹­ ë°œí‘œë¡œ ê¸‰ë“±í–ˆìŠµë‹ˆë‹¤." (O) / "ì†Œí­ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤." (X)

       B. **email_summary (ì´ë©”ì¼ ë¦¬í¬íŠ¸ìš©)**:
          - ê¸¸ì´: **3~4ë¬¸ì¥ì˜ ê¹Šì´ ìˆëŠ” ë¶„ì„**.
          - ë‚´ìš©: í•´ë‹¹ ì¢…ëª©ê³¼ ì§ì ‘ ê´€ë ¨ëœ ë‰´ìŠ¤(ê³„ì•½, ì‹¤ì , CEO ë°œì–¸, ê±°ì‹œê²½ì œ ì˜í–¥)ë¥¼ ì°¾ì•„ ì¸ê³¼ê´€ê³„ë¥¼ ì„¤ëª….
          - **ì£¼ì˜:** í•œêµ­ êµ­ë‚´ ì´ìŠˆ(ì„¸ì œì§€ì› ë“±)ë¥¼ ë¯¸êµ­ ì£¼ì‹ì— ì–µì§€ë¡œ ê°–ë‹¤ ë¶™ì´ì§€ ë§ˆì‹œì˜¤. ë‰´ìŠ¤ê°€ ì—†ìœ¼ë©´ "íŠ¹ì´ ì´ìŠˆ ì—†ìŒ"ì´ë¼ê³  ì†”ì§íˆ ì ìœ¼ì‹œì˜¤.
          - í˜•ì‹: "~ë•Œë¬¸ì— ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤."ì™€ ê°™ì€ í‰ì„œë¬¸.

    2. **economic_insight**:
       - **[ê²½ì œ ë‰´ìŠ¤ ê²€ìƒ‰ ê²°ê³¼]**ì—ì„œ íŒ©íŠ¸ë¥¼ ì°¾ì•„ë‚´ì„¸ìš”.
       - **fear_greed_index** (0~100 ìˆ«ì): ê²€ìƒ‰ ê²°ê³¼ì—ì„œ í™•ì¸ëœ 'Fear & Greed Index' í˜„ì¬ ìˆ˜ì¹˜ (ì˜ˆ: 65). ëª» ì°¾ìœ¼ë©´ "N/A".
       - **market_sentiment**: ìˆ˜ì¹˜ì— ë”°ë¥¸ ìƒíƒœ (ì˜ˆ: Greed). ëª» ì°¾ìœ¼ë©´ "N/A".
       - **calendar**: ê²€ìƒ‰ ê²°ê³¼ì— ì–¸ê¸‰ëœ ì´ë²ˆ ì£¼ ì£¼ìš” ê²½ì œ ì¼ì • 3ê°€ì§€. **ë°˜ë“œì‹œ ë‚ ì§œ í¬í•¨í•  ê²ƒ** (ì˜ˆ: "CPI ë°œí‘œ (2025-12-31)")
       - **sector_summary**: ê²€ìƒ‰ ê²°ê³¼ì—ì„œ íŒŒì•…ëœ ì˜¤ëŠ˜ ìƒìŠ¹/í•˜ë½ ì£¼ë„ ì„¹í„° 1ì¤„ ìš”ì•½. (ì˜ˆ: "ê¸°ìˆ ì£¼ ê°•ì„¸, ì—ë„ˆì§€ ì•½ì„¸")
    
    3. **news_items**: 
       - ì œê³µëœ ë‰´ìŠ¤ ì œëª©ê³¼ 1ë¬¸ì¥ ìƒì„¸ ë‚´ìš©(detail).
       - **ì£¼ì˜:** ë‰´ìŠ¤ê°€ ì—†ìœ¼ë©´ "íŠ¹ì´ ì´ìŠˆ ì—†ìŒ"ì´ë¼ê³  ì†”ì§íˆ ì ìœ¼ì‹œì˜¤.

    4. **youtube_items**: 
       - ì œê³µëœ ìœ íŠœë¸Œ ì˜ìƒì˜ ì œëª© ë“±ì„ ë³´ê³  í•µì‹¬ ì£¼ì œë¥¼ **1~2ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½**í•˜ì„¸ìš”.
    
    [ì§€ì‹œì‚¬í•­ 2: ë°©ì†¡ ëŒ€ë³¸ (Audio Script)]
    - **scene4_target_symbol**: 'stock_details' ì¤‘ **ê°€ì¥ ì´ì•¼ê¹ƒê±°ë¦¬ê°€ ë§ê±°ë‚˜ ë“±ë½í­ì´ í° ì¢…ëª©(ì£¼ì¸ê³µ)**ì˜ symbolì„ ë”± í•˜ë‚˜ë§Œ ì ìœ¼ì‹œì˜¤. (ì˜ˆ: "TSLA")
    - **ì‹¤ì œ ì˜ìƒì—ì„œ ì½ì–´ì¤„ ë‚´ë ˆì´ì…˜ ëŒ€ë³¸**ì„ ì‘ì„±í•˜ì„¸ìš”. (êµ¬ì–´ì²´, í•´ìš”ì²´, ìì—°ìŠ¤ëŸ½ê²Œ)
    - **ë¬¸ì¥ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šê²Œ ì ì ˆíˆ ëŠì–´ì„œ ì‘ì„±í•˜ì„¸ìš”.**
    - **scripts**: ì‹¤ì œ ì˜ìƒ ë‚´ë ˆì´ì…˜ ëŒ€ë³¸ (êµ¬ì–´ì²´, í•´ìš”ì²´).
       - **scene1 (Opening)**: "ì•ˆë…•í•˜ì„¸ìš”, {today_date} ë°ì¼ë¦¬ ë¸Œë¦¬í•‘ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ ë¯¸ ì¦ì‹œëŠ”..." (ì„¹í„°/ë§µ ë¶„ìœ„ê¸° ì–¸ê¸‰)
       - **scene2 (News)**: "ë¨¼ì € ì£¼ìš” ë‰´ìŠ¤ì…ë‹ˆë‹¤." (ê°€ì¥ ì¤‘ìš”í•œ ë‰´ìŠ¤ 1~2ê°œ í—¤ë“œë¼ì¸ ì–¸ê¸‰)
       - **scene2_5 (Economy)**: "ì˜¤ëŠ˜ì˜ ê²½ì œ ì§€í‘œì…ë‹ˆë‹¤." (ê³µí¬ì§€ìˆ˜ ìƒíƒœì™€ ì£¼ìš” ì¼ì • ì–¸ê¸‰)
       - **scene3 (Stocks)**: "ì£¼ìš” ì¢…ëª© íë¦„ì…ë‹ˆë‹¤." (ê°€ì¥ ë“±ë½ì´ í° ì¢…ëª© 1~2ê°œ ìœ„ì£¼ë¡œ ì½”ë©˜íŠ¸. *ëª¨ë“  ì¢…ëª©ì„ ë‹¤ ì½ì§€ ë§ê³  íŠ¹ì§•ì£¼ ìœ„ì£¼ë¡œ ìš”ì•½*)
       - **scene4 (Chart)**: "íŠ¹íˆ ì£¼ëª©í•  ì¢…ëª©ì€... (ì²«ë²ˆì§¸ ì¢…ëª©)ì…ë‹ˆë‹¤." (ì°¨íŠ¸ í™”ë©´ì—ì„œ ì½ì„ ë©˜íŠ¸, ë°˜ë“œì‹œ ìœ„ì—ì„œ ì„ íƒí•œ **'scene4_target_symbol'**ì— ëŒ€í•œ ì°¨íŠ¸ ë¶„ì„ ë‚´ìš©ì„ ì‘ì„±í•˜ì‹œì˜¤.)
       - **scene5 (YouTube)**: "ìœ íŠœë¸Œ ì¸ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤. (ì±„ë„ëª…)ì—ì„œëŠ”..." (ì£¼ìš” ì˜ìƒ 1ê°œ ì–¸ê¸‰)
       - **scene6 (Closing)**: "ì´ìƒìœ¼ë¡œ ë¸Œë¦¬í•‘ì„ ë§ˆì¹©ë‹ˆë‹¤. ì„±ê³µ íˆ¬ìë¥¼ ê¸°ì›í•©ë‹ˆë‹¤."
       
    [JSON í˜•ì‹]
    {{
        "scene4_target_symbol": "TSLA",
        "stock_details": [ {{"symbol": "AAPL", "video_summary": "...", "email_summary": "..."}} ],
        "economic_insight": {{ "fear_greed_index": 65, "market_sentiment": "Greed", "calendar": [...], "sector_summary": "..." }},
        "news_items": [ {{"title": "...", "detail": "..."}} ],
        "youtube_items": [ {{"summary": "ì˜ìƒ í•µì‹¬ ìš”ì•½ 1~2ë¬¸ì¥"}} ],
        "scripts": {{
            "scene1": "...",
            "scene2": "...",
            "scene2_5": "...",
            "scene3": "...",
            "scene4": "...",
            "scene5": "...",
            "scene6": "..."
        }}
    }}
    """

    
    candidate_models = ['models/gemini-2.5-flash', 'models/gemini-2.5-pro', 'models/gemini-pro']
    
    for model_name in candidate_models:
        print(f"   ğŸ¤– ë¶„ì„ ì‹œë„ ì¤‘... (Model: {model_name})")
        try:
            # ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œ ìƒì„±
            current_model = genai.GenerativeModel(model_name)

            # [Step 4] AI ì‘ë‹µ ì „ì²˜ë¦¬
            # AI ì‘ë‹µì—ì„œ ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ íƒœê·¸ ì œê±°
            res           = current_model.generate_content(prompt, safety_settings=safety_settings)
            text          = res.text.replace("```json", "").replace("```", "").strip()
            
            # JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ (ì‘ë‹µì— ì¶”ê°€ í…ìŠ¤íŠ¸ê°€ ìˆì„ ìˆ˜ ìˆìŒ)
            start         = text.find('{')   # ì²« ë²ˆì§¸ { ìœ„ì¹˜
            end           = text.rfind('}')  # ë§ˆì§€ë§‰ } ìœ„ì¹˜
            if start == -1 or end == -1:
                raise ValueError("JSON í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ")            
            
            # [Step 5] JSON íŒŒì‹± ë° ì£¼ì¸ê³µ ì¢…ëª© ì²˜ë¦¬
            data          = json.loads(text[start:end+1])
            target_symbol = data.get('scene4_target_symbol', '')  # AIê°€ ì„ íƒí•œ ì£¼ì¸ê³µ ì¢…ëª©
            if target_symbol:
                print(f"   ğŸ¯ AIê°€ ì„ íƒí•œ ì°¨íŠ¸ ë¶„ì„ ì¢…ëª©: {target_symbol}")
                # í•´ë‹¹ ì¢…ëª© ì°¾ì•„ì„œ ë§¨ ì•ìœ¼ë¡œ ë³´ë‚´ê¸° (ì°¨íŠ¸ í™”ë©´ì—ì„œ ì´ ì¢…ëª©ì´ í‘œì‹œë¨)
                for i, s in enumerate(stocks):
                    if s['symbol'] == target_symbol:
                        target_stock = stocks.pop(i)      # ë¦¬ìŠ¤íŠ¸ì—ì„œ ë½‘ì•„ì„œ
                        stocks.insert(0, target_stock)    # ë§¨ ì•ì— ë„£ìŒ
                        break            
            
            # [Step 6] AI ë¶„ì„ ê²°ê³¼ë¥¼ ì›ë³¸ ë°ì´í„°ì— ë§¤í•‘
            # 1. ë°ì´í„° ë§¤í•‘ (Visual Data)
            # AIê°€ ìƒì„±í•œ ìš”ì•½ì„ symbol ê¸°ë°˜ìœ¼ë¡œ ë§¤í•‘
            summary_map_v = {item['symbol']: item.get('video_summary', '') for item in data.get('stock_details', [])}
            summary_map_e = {item['symbol']: item.get('email_summary', '') for item in data.get('stock_details', [])}
            
            # ê° ì¢…ëª©ì— AI ë¶„ì„ ê²°ê³¼ ì¶”ê°€
            for s in stocks:
                s['video_summary'] = summary_map_v.get(s['symbol'], "ë¶„ì„ ì¤‘...")     # ì˜ìƒ ìë§‰ìš© ì§§ì€ ìš”ì•½
                s['email_summary'] = summary_map_e.get(s['symbol'], "íŠ¹ì´ì‚¬í•­ ì—†ìŒ")  # ì´ë©”ì¼ ë¦¬í¬íŠ¸ìš© ìƒì„¸ ë¶„ì„
                s['analysis']      = s['email_summary']  # í˜¸í™˜ì„±ì„ ìœ„í•œ ë³„ì¹­

            # ë‰´ìŠ¤ì— ìƒì„¸ ë‚´ìš© ì¶”ê°€
            for i, n in enumerate(news):
                if i < len(data.get('news_items', [])):
                    n['detail']    = data['news_items'][i].get('detail', '')
            
            # ìœ íŠœë¸Œ ì˜ìƒì— ìš”ì•½ ì¶”ê°€
            for i, y in enumerate(youtube):
                if i < len(data.get('youtube_items', [])):
                    y['summary']   = data['youtube_items'][i].get('summary', '')

            # [Step 7] ëŒ€ë³¸ ì¶”ì¶œ (Audio Script)
            # 2. ëŒ€ë³¸ ì¶”ì¶œ (Audio Script)
            # AIê°€ ìƒì„±í•œ ëŒ€ë³¸ì„ ì¶”ì¶œí•˜ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ ë©˜íŠ¸ë¡œ ëŒ€ì²´
            # scriptsê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©˜íŠ¸ë¡œ ë°©ì–´
            generated_scripts = data.get('scripts', {
                "scene1"  : f"{today_date} ì¦ì‹œ ë¸Œë¦¬í•‘ì„ ì‹œì‘í•©ë‹ˆë‹¤.",
                "scene2"  : "ì£¼ìš” ë‰´ìŠ¤ì…ë‹ˆë‹¤.",
                "scene2_5": "ê²½ì œ ì§€í‘œë¥¼ í™•ì¸í•˜ê² ìŠµë‹ˆë‹¤.",
                "scene3"  : "ì£¼ìš” ì¢…ëª© í˜„í™©ì…ë‹ˆë‹¤.",
                "scene4"  : "ì°¨íŠ¸ ë¶„ì„ì…ë‹ˆë‹¤.",
                "scene5"  : "ìœ íŠœë¸Œ íŠ¸ë Œë“œì…ë‹ˆë‹¤.",
                "scene6"  : "ì‹œì²­í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤."
            })

            print(f"   âœ… ë¶„ì„ ì„±ê³µ (by {model_name})")
            # ë¶„ì„ëœ ë°ì´í„°ì™€ ëŒ€ë³¸ ë°˜í™˜
            return stocks, news, youtube, data.get('economic_insight', {}), generated_scripts
            
        except Exception as e:
            print(f"âš ï¸ AI ë¶„ì„/ì§‘í•„ ì‹¤íŒ¨: {e}")
            # ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë°ì´í„° ë°˜í™˜ (AI ë¶„ì„ ì—†ì´ ì›ë³¸ ë°ì´í„°ë§Œ)
            return stocks, news, youtube, {}, {}

    # ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨ ì‹œ (ëª¨ë“  ëª¨ë¸ì´ ì‹¤íŒ¨í•œ ê²½ìš°)
    print("âŒ ìµœì¢… ë¶„ì„ ì‹¤íŒ¨: ê¸°ë³¸ ë°ì´í„°ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.")
    return stocks, news, youtube, {}, {}            



# -----------------------------------------------------------------------------------------------------------------------------#
# [ìˆ˜ì •ë¨] ëŒ€ë³¸ ì‘ì„± ë¡œì§ (ì£¼ì‹ ë°ì´í„° ì—†ì„ ë•Œ ëŒ€ì‘ ì¶”ê°€)
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” analyze_and_summarizeì—ì„œ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš°ì˜ ëŒ€ë¹„ìš©ì…ë‹ˆë‹¤.
# ì´ë¯¸ ìš”ì•½ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ 6ê°œ ì”¬ì˜ ì˜ìƒ ëŒ€ë³¸ë§Œ ë”°ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
# íœ´ì¥ì¼ì—ëŠ” ì£¼ì‹ ë°ì´í„° ì—†ì´ ë‰´ìŠ¤ë§Œìœ¼ë¡œ ëŒ€ë³¸ì„ ì‘ì„±í•˜ëŠ” ë¡œì§ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
# (í˜„ì¬ëŠ” analyze_and_summarizeì—ì„œ ëŒ€ë³¸ê¹Œì§€ í•œ ë²ˆì— ìƒì„±í•˜ë¯€ë¡œ ì´ í•¨ìˆ˜ëŠ” ë°±ì—…ìš©)
# -----------------------------------------------------------------------------------------------------------------------------#

def plan_video_script(stocks, news, youtube):
    """
    ì´ë¯¸ ìš”ì•½ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ëŒ€ë³¸(Script)ë§Œ ì‘ì„±í•©ë‹ˆë‹¤.
    
    Args:
        stocks (list): AI ë¶„ì„ì´ ì™„ë£Œëœ ì£¼ì‹ ë°ì´í„°
        news (list): AI ë¶„ì„ì´ ì™„ë£Œëœ ë‰´ìŠ¤ ë°ì´í„°
        youtube (list): AI ë¶„ì„ì´ ì™„ë£Œëœ ìœ íŠœë¸Œ ë°ì´í„°
    
    Returns:
        dict: ëŒ€ë³¸ ë”•ì…”ë„ˆë¦¬ {'title', 'scene1', ..., 'scene6'}
              ì‹¤íŒ¨ ì‹œ None ë°˜í™˜
    
    [ì”¬ êµ¬ì„±]
    1. Intro: ì‹œì¥ ìƒí™© ë° ë©”ì¸ ì£¼ì œ ì–¸ê¸‰
    2. News: ì£¼ìš” ë‰´ìŠ¤ ë¸Œë¦¬í•‘
    3. Main Topic: ë©”ì¸ ì¢…ëª©/ì£¼ì œ ì†Œê°œ
    4. Detail: ìƒì„¸ ë¶„ì„
    5. Reaction: ìœ íŠœë¸Œ/ëŒ€ì¤‘ ë°˜ì‘
    6. Outro: í´ë¡œì§• ë° íˆ¬ì ìœ ì˜ì‚¬í•­
    """
    print("ğŸ“ AI ì‘ê°€: ì˜ìƒ ëŒ€ë³¸ ì‘ì„± ì¤‘...")
    
    # [ìˆ˜ì •] ì£¼ì‹ì´ í•˜ë‚˜ë„ ì—†ì„ ê²½ìš°(íœ´ì¥ì¼) ëŒ€ì‘ ë¡œì§
    # íœ´ì¥ì¼ì—ëŠ” ì£¼ì‹ ë°ì´í„°ê°€ ì—†ìœ¼ë¯€ë¡œ ë‰´ìŠ¤ë¥¼ ë©”ì¸ ì£¼ì œë¡œ ì‚¬ìš©
    main_topic    = ""
    main_summary  = ""
    
    if stocks:
        # ì£¼ì‹ì´ ìˆìœ¼ë©´ ì²« ë²ˆì§¸ ì¢…ëª©ì„ ë©”ì¸ìœ¼ë¡œ (AIê°€ ì„ íƒí•œ ì£¼ì¸ê³µ ì¢…ëª©)
        target_stock = stocks[0]
        main_topic   = target_stock['symbol']
        main_summary = target_stock.get('analysis', '')
    elif news:
        # ì£¼ì‹ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë‰´ìŠ¤ë¥¼ ë©”ì¸ìœ¼ë¡œ
        main_topic   = "Global News"
        main_summary = news[0].get('summary', news[0]['title'])
    else:
        # ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ëŒ€ë³¸ ì‘ì„± ë¶ˆê°€
        print("âŒ ëŒ€ë³¸ì„ ì‘ì„±í•  ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")
        return None

    # AIì—ê²Œ ì „ë‹¬í•  ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° êµ¬ì„±
    context = json.dumps({
        'main_topic'    : main_topic,
        'main_summary'  : main_summary,
        'news'          : [n.get('summary', n['title']) for n in news[:4]],     # ë‰´ìŠ¤ ìš”ì•½ ë¦¬ìŠ¤íŠ¸
        'youtube'       : [y.get('summary', y['title']) for y in youtube[:4]]   # ìœ íŠœë¸Œ ìš”ì•½ ë¦¬ìŠ¤íŠ¸
    }, ensure_ascii=False)
    
    # ëŒ€ë³¸ ìƒì„± í”„ë¡¬í”„íŠ¸
    prompt = f"""
    ì•„ë˜ ìš”ì•½ëœ ê¸ˆìœµ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ 6ë‹¨ê³„ ì‡¼ì¸  ëŒ€ë³¸ì„ ì‘ì„±í•´.
    
    [ë°ì´í„°]
    {context}
    
    [êµ¬ì„±]
    Scene 1 (Intro): ì‹œì¥ ìƒí™© ë¸Œë¦¬í•‘ ë° ì˜¤ëŠ˜ì˜ ë©”ì¸ ì£¼ì œ({main_topic}) ì–¸ê¸‰.
    Scene 2 (News): ì£¼ìš” ë‰´ìŠ¤ ë¸Œë¦¬í•‘ (ë¹ ë¥´ê²Œ).
    Scene 3 (Main Topic): {main_topic} ì§‘ì¤‘ ë¶„ì„ ì†Œê°œ.
    Scene 4 (Detail): {main_topic}ì— ëŒ€í•œ êµ¬ì²´ì  ë¶„ì„ ë©˜íŠ¸ ({main_summary}).
    Scene 5 (Reaction): ìœ íŠœë¸Œë‚˜ ëŒ€ì¤‘ì˜ ë°˜ì‘ ì „ë‹¬.
    Scene 6 (Outro): í´ë¡œì§• ë©˜íŠ¸ (íˆ¬ì ìœ ì˜ì‚¬í•­ í¬í•¨).

    [JSON ë°˜í™˜]
    {{
        "title": "ì˜ìƒ ì œëª© (ìê·¹ì ì´ê³  í¥ë¯¸ë¡­ê²Œ)",
        "scene1": "ëŒ€ë³¸ ë‚´ìš©...", 
        "scene2": "...", 
        "scene3": "...", 
        "scene4": "...", 
        "scene5": "...", 
        "scene6": "..."
    }}
    """
    try:
        # AIë¡œ ëŒ€ë³¸ ìƒì„±
        res       = model.generate_content(prompt)
        text      = res.text.replace("```json", "").replace("```", "").strip()
        
        # JSON ë¶€ë¶„ ì¶”ì¶œ
        start_idx = text.find('{')
        end_idx   = text.rfind('}')
        
        if start_idx != -1 and end_idx != -1:
            text = text[start_idx:end_idx+1]
            
        return json.loads(text)
    except Exception as e: 
        print(f"âš ï¸ ëŒ€ë³¸ ì‘ì„± ì‹¤íŒ¨: {e}")
        return None



# -----------------------------------------------------------------------------------------------------------------------------#
# ---  5. í‚¤ì›Œë“œ ê¸°ë°˜ íŠ¸ë Œë“œ ì˜ìƒ ìˆ˜ì§‘ ---
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ì„¤ì •ëœ í‚¤ì›Œë“œë¡œ ìœ íŠœë¸Œ ê²€ìƒ‰ì„ ìˆ˜í–‰í•˜ì—¬ íŠ¸ë Œë“œ ì˜ìƒì„ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
# ì±„ë„ ê¸°ë°˜ ìˆ˜ì§‘(collect_channel_youtube_data)ê³¼ ë‹¬ë¦¬, íŠ¹ì • ì£¼ì œ/í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.
# ì˜ˆ: "ë¯¸êµ­ ê¸ˆë¦¬ ì¸ìƒ", "í…ŒìŠ¬ë¼ ì£¼ê°€" ë“±ì˜ í‚¤ì›Œë“œë¡œ ìµœì‹  í•«ì´ìŠˆ ì˜ìƒ ë°œêµ´
# -----------------------------------------------------------------------------------------------------------------------------#

def collect_keyword_youtube_data(keywords):
    """
    í‚¤ì›Œë“œ ê¸°ë°˜ìœ¼ë¡œ ìœ íŠœë¸Œ íŠ¸ë Œë“œ ì˜ìƒì„ ê²€ìƒ‰í•˜ê³  ìˆ˜ì§‘í•©ë‹ˆë‹¤.
    
    Args:
        keywords (list): ê²€ìƒ‰í•  í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ (ì˜ˆ: ["ë¯¸êµ­ ê¸ˆë¦¬", "í…ŒìŠ¬ë¼ ì£¼ê°€"])
    
    Returns:
        list: íŠ¸ë Œë“œ ì˜ìƒ ë°ì´í„° ë”•ì…”ë„ˆë¦¬ ë¦¬ìŠ¤íŠ¸
              ê° í•­ëª©: {'type', 'source', 'channel_name', 'title', 'url', 'content'}
    
    [ì±„ë„ ê¸°ë°˜ ìˆ˜ì§‘ê³¼ì˜ ì°¨ì´ì ]
    - ì±„ë„ ê¸°ë°˜: íŠ¹ì • ì±„ë„ì˜ ìµœì‹  ì˜ìƒ ìˆ˜ì§‘ (êµ¬ë… ì±„ë„ ëª¨ë‹ˆí„°ë§)
    - í‚¤ì›Œë“œ ê¸°ë°˜: ì£¼ì œë³„ ê²€ìƒ‰ìœ¼ë¡œ í•«ì´ìŠˆ ë°œêµ´ (íŠ¸ë Œë“œ íŒŒì•…)
    """
    print("ğŸ”¥ ìœ íŠœë¸Œ íŠ¸ë Œë“œ ê²€ìƒ‰ ì¤‘...")
    youtube     = build('youtube', 'v3', developerKey=YOUTUBE_API_KEY)
    trend_data  = []
    
    # 24ì‹œê°„ ì „ ì‹œê°„ êµ¬í•˜ê¸° (ISO 8601 í˜•ì‹)
    # YouTube APIëŠ” publishedAfter íŒŒë¼ë¯¸í„°ë¡œ íŠ¹ì • ì‹œì  ì´í›„ ì˜ìƒë§Œ í•„í„°ë§
    yesterday   = (datetime.utcnow() - timedelta(days=1)).isoformat("T") + "Z"

    for keyword in keywords:
        try:
            # ê²€ìƒ‰ API í˜¸ì¶œ: 24ì‹œê°„ ì´ë‚´, ê´€ë ¨ë„ ìˆœ
            # YouTube Search APIë¥¼ ì‚¬ìš©í•˜ì—¬ í‚¤ì›Œë“œ ê²€ìƒ‰
            req = youtube.search().list(
                part           = "snippet",      # ì˜ìƒ ê¸°ë³¸ ì •ë³´ ìš”ì²­
                q              = keyword,        # ê²€ìƒ‰ í‚¤ì›Œë“œ
                order          = "relevance",    # ê´€ë ¨ë„ìˆœ ì •ë ¬ (viewCount, date ë“± ê°€ëŠ¥)
                publishedAfter = yesterday,      # 24ì‹œê°„ ì´ë‚´ ì˜ìƒë§Œ
                type           = "video",        # ì˜ìƒë§Œ (channel, playlist ì œì™¸)
                maxResults     = 1               # í‚¤ì›Œë“œë‹¹ 1ê°œë§Œ (API í• ë‹¹ëŸ‰ ì ˆì•½)
            )
            res = req.execute()
            
            # ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë‹¤ìŒ í‚¤ì›Œë“œë¡œ
            if not res.get('items'): continue
            
            # ì²« ë²ˆì§¸ ê²€ìƒ‰ ê²°ê³¼ ì‚¬ìš©
            item           = res['items'][0]
            vid            = item['id']['videoId']            # ì˜ìƒ ID
            title          = item['snippet']['title']         # ì˜ìƒ ì œëª©
            channel_title  = item['snippet']['channelTitle']  # ì±„ë„ëª…
            
            # ìë§‰ ì¶”ì¶œ ì‹œë„
            transcript     = get_timed_transcript(vid)
            content        = transcript[:40000] if transcript else f"(ìë§‰ ì—†ìŒ) {item['snippet']['description'][:1000]}"

            # ìˆ˜ì§‘ ë°ì´í„° ì €ì¥
            trend_data.append({
                'type'          : 'keyword',                    # ìˆ˜ì§‘ ìœ í˜• (í‚¤ì›Œë“œ ê¸°ë°˜)
                'source'        : f"í‚¤ì›Œë“œ: {keyword}",          # ê²€ìƒ‰ í‚¤ì›Œë“œ í‘œì‹œ
                'channel_name'  : channel_title,                # ì±„ë„ëª…
                'title'         : title,                         # ì˜ìƒ ì œëª©
                'url'           : f"https://www.youtube.com/watch?v={vid}",  # ì˜ìƒ URL
                'content'       : content                        # ìë§‰ ë˜ëŠ” ì„¤ëª…
            })
            print(f"  - [íŠ¸ë Œë“œ/{keyword}] í™•ë³´: {title}")
        except Exception as e:
            print(f"  - [íŠ¸ë Œë“œ/{keyword}] ì—ëŸ¬: {e}")
            
    return trend_data



# -----------------------------------------------------------------------------------------------------------------------------#
# ë¦¬í¬íŠ¸ ìƒì„± í•¨ìˆ˜ (ì‚¬ìš©ì ì›ë³¸ í”„ë¡¬í”„íŠ¸ ë³µì› + ì¼ê´€ì„± ì§€ì¹¨ ì¶”ê°€)
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ìˆ˜ì§‘/ë¶„ì„ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ CEOìš© HTML ì´ë©”ì¼ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
# ë¦¬í¬íŠ¸ëŠ” í¬ê²Œ 3ê°œ íŒŒíŠ¸ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:
# 1. ì˜ìƒ ì„¹ì…˜ (Section 0): ìœ íŠœë¸Œ Shorts ì˜ìƒ ë§í¬
# 2. ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ (Section 1): íˆíŠ¸ë§µ, ê³µí¬ì§€ìˆ˜, ê²½ì œ ì¼ì •
# 3. AI ë¶„ì„ ì„¹ì…˜ (Section 2~5): ì¢…ëª© ë¶„ì„, ë‰´ìŠ¤ ì‹¬ì¸µ ë¶„ì„, ìœ íŠœë¸Œ ì¸ì‚¬ì´íŠ¸
# 
# HTML í˜•ì‹ìœ¼ë¡œ ìƒì„±ë˜ë©°, ì´ë©”ì¼ ë³¸ë¬¸ì— ì§ì ‘ ì‚½ì…ë©ë‹ˆë‹¤.
# ì´ë¯¸ì§€(íˆíŠ¸ë§µ)ëŠ” cid: í”„ë¡œí† ì½œë¡œ ì²¨ë¶€íŒŒì¼ ì°¸ì¡°í•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

def generate_report(stocks, general_news, channel_videos, trend_videos, video_url=None, economy_data=None):
    """
    CEOìš© HTML ì´ë©”ì¼ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        stocks (list): AI ë¶„ì„ì´ ì™„ë£Œëœ ì£¼ì‹ ë°ì´í„°
        general_news (list): ë‰´ìŠ¤ ë°ì´í„°
        channel_videos (list): ì±„ë„ ê¸°ë°˜ ìœ íŠœë¸Œ ì˜ìƒ
        trend_videos (list): í‚¤ì›Œë“œ ê¸°ë°˜ íŠ¸ë Œë“œ ì˜ìƒ
        video_url (str): ìœ íŠœë¸Œ Shorts ì˜ìƒ URL (ì„ íƒ)
        economy_data (dict): ê²½ì œ ì¸ì‚¬ì´íŠ¸ ë°ì´í„° (ì„ íƒ)
    
    Returns:
        str: ì™„ì„±ëœ HTML ë¦¬í¬íŠ¸ ë¬¸ìì—´
    
    [ë¦¬í¬íŠ¸ êµ¬ì¡°]
    - Section 0: 1ë¶„ ìš”ì•½ ì˜ìƒ ë§í¬
    - Section 1: Market Dashboard (íˆíŠ¸ë§µ, ê³µí¬ì§€ìˆ˜, ê²½ì œ ì¼ì •)
    - Section 2: ê´€ì‹¬ ì¢…ëª© ë¶„ì„
    - Section 3: ë‰´ìŠ¤ ì‹¬ì¸µ ë¶„ì„
    - Section 4: ìœ íŠœë¸Œ ì±„ë„ ì¸ì‚¬ì´íŠ¸
    - Section 5: íŠ¸ë Œë“œ ì˜ìƒ
    """
    print("ğŸ“ CEO ë§ì¶¤í˜• ì‹¬ì¸µ ë¦¬í¬íŠ¸ ì‘ì„± ì¤‘...")
    
    # [Section 0] ì˜ìƒ ì„¹ì…˜ HTML êµ¬ì„±
    # ìœ íŠœë¸Œ Shorts ì˜ìƒì´ ì—…ë¡œë“œë˜ì—ˆìœ¼ë©´ ë§í¬ í‘œì‹œ
    # 1. [Section 0] ì˜ìƒ ì„¹ì…˜ HTML (ê¸°ì¡´ ë™ì¼)
    video_section_html = ""
    if video_url:
        # ì˜ìƒ URLì´ ìˆìœ¼ë©´ í´ë¦­ ê°€ëŠ¥í•œ ë§í¬ ì¹´ë“œ ìƒì„±
        video_section_html = f"""
        <h2>ğŸ¬ [Section 0] ì˜¤ëŠ˜ì 1ë¶„ ìš”ì•½ (Shorts)</h2>
        <p><b>ğŸ’¡ ë°”ì˜ì‹  CEOë¥¼ ìœ„í•œ 1ë¶„ ë¸Œë¦¬í•‘:</b></p>
        <p>ì˜¤ëŠ˜ì˜ í•µì‹¬ ì´ìŠˆì™€ ì£¼ê°€ ë³€ë™ ì›ì¸ì„ ì˜ìƒì„ í†µí•´ ë¹ ë¥´ê²Œ í™•ì¸í•˜ì„¸ìš”.</p>
        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #e9ecef; margin: 15px 0;">
            <a href="{video_url}" style="font-size: 20px; font-weight: bold; color: #c0392b; text-decoration: none;">
                â–¶ï¸ 1ë¶„ ë¸Œë¦¬í•‘ ì˜ìƒ ì¬ìƒí•˜ê¸° (Click)
            </a>
            <p style="color: #666; font-size: 0.9em; margin-top: 10px;">(ìœ íŠœë¸Œ ë§í¬ë¡œ ì´ë™í•©ë‹ˆë‹¤)</p>
        </div>
        <hr style="border: 0; border-top: 1px dashed #ddd; margin: 30px 0;">
        """
    elif not stocks:
        # íœ´ì¥ì¼ì´ê±°ë‚˜ ë°ì´í„° ë¶€ì¡± ì‹œ ì•ˆë‚´ ë©”ì‹œì§€
        video_section_html = """
        <h2>ğŸ¬ [Section 0] ì˜¤ëŠ˜ì 1ë¶„ ìš”ì•½</h2>
        <p><i>(ì˜¤ëŠ˜ì€ ì£¼ì‹ ì‹œì¥ íœ´ì¥ì¼ ë˜ëŠ” ë°ì´í„° ë¶€ì¡±ìœ¼ë¡œ ì˜ìƒì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.)</i></p>
        <hr>
        """

    # [Section 1] Market Dashboard êµ¬ì„±
    # íˆíŠ¸ë§µ ì´ë¯¸ì§€, ê³µí¬íƒìš•ì§€ìˆ˜, ê²½ì œ ì¼ì •ì„ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œ
    # [NEW] [Section 1] Market Dashboard (íŒŒì´ì¬ì—ì„œ ì§ì ‘ ìƒì„±)
    dashboard_html = ""
    if economy_data:
        # AIê°€ ì¶”ì¶œí•œ ê²½ì œ ì¸ì‚¬ì´íŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        fg_score = economy_data.get('fear_greed_index', 'N/A')   # ê³µí¬íƒìš•ì§€ìˆ˜ (0~100)
        fg_state = economy_data.get('market_sentiment', '')      # ì§€ìˆ˜ ìƒíƒœ (Greed, Fear ë“±)
        
        # [í•µì‹¬ ìˆ˜ì •] calendarê°€ ë¬¸ìì—´("N/A")ë¡œ ì˜¤ë©´ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ì—¬ ì„¸ë¡œ ì¶œë ¥ ë°©ì§€
        # AIê°€ ì¼ì •ì„ ëª» ì°¾ìœ¼ë©´ "N/A" ë¬¸ìì—´ë¡œ ë°˜í™˜í•  ìˆ˜ ìˆìŒ
        calendar = economy_data.get('calendar', [])
        if isinstance(calendar, str):
            calendar = [calendar]  # "N/A" -> ["N/A"]
            
        if not calendar: calendar = ["ì˜ˆì •ëœ ì£¼ìš” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤."]

        # ê²½ì œ ì¼ì •ì„ HTML ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œìœ¼ë¡œ ë³€í™˜
        cal_items = "".join([f"<li style='margin-bottom:5px;'>{evt}</li>" for evt in calendar])
        
        # ëŒ€ì‹œë³´ë“œ HTML êµ¬ì„± (Flexbox ë ˆì´ì•„ì›ƒ)
        dashboard_html = f"""
        <h2>ğŸ—ºï¸ [Section 1] Market Dashboard</h2>
        <h3 style="margin-top: 20px;">1. Global Market Map</h3>
        <div style="text-align:center; margin: 15px 0;">
            <img src="cid:tradingview_map" alt="S&P 500 Heatmap" style="width:100%; max-width:600px; border-radius:10px; border:1px solid #ddd;">
        </div>
        
        <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top:30px;">
            <div style="flex: 1; background-color: #f8f9fa; padding: 15px; border-radius: 10px;">
                <h4 style="margin: 0 0 10px 0;">ğŸ§  Fear & Greed</h4>
                <p style="font-size: 24px; font-weight: bold; color: #c0392b; margin: 0;">{fg_score}</p>
                <p style="color: #666; margin: 0;">({fg_state})</p>
            </div>
            <div style="flex: 1; background-color: #f8f9fa; padding: 15px; border-radius: 10px;">
                <h4 style="margin: 0 0 10px 0;">ğŸ“… Schedule</h4>
                <ul style="padding-left: 20px; margin: 0;">{cal_items}</ul>
            </div>
        </div>
        <hr style="border: 0; border-top: 1px dashed #ddd; margin: 30px 0;">
        """

    # [Section 2~5] AIê°€ ìƒì„±í•˜ëŠ” ì‹¬ì¸µ ë¶„ì„ ë¦¬í¬íŠ¸
    # 2. AI ë¦¬í¬íŠ¸ ìƒì„±
    # ëª¨ë“  ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ë¬¶ì–´ì„œ AIì—ê²Œ ì „ë‹¬
    full_data = json.dumps({
        "stocks"   : stocks, 
        "news"     : general_news,
        "channels" : channel_videos,
        "trends"   : trend_videos
    }, ensure_ascii=False)

    # [í•µì‹¬] ì‚¬ìš©ìê°€ ë§Œì¡±í–ˆë˜ ê·¸ í”„ë¡¬í”„íŠ¸ë¥¼ ë³µì›í•˜ë˜, ì„¹ì…˜ 1 ì§€ì¹¨ë§Œ ìˆ˜ì •
    # CEOê°€ ì›ë³¸ ê¸°ì‚¬ë¥¼ ë³¼ í•„ìš” ì—†ì´ ë¦¬í¬íŠ¸ë§Œìœ¼ë¡œ ì¶©ë¶„íˆ ì´í•´í•  ìˆ˜ ìˆë„ë¡
    # êµ¬ì²´ì ì¸ ìˆ«ìì™€ íŒ©íŠ¸ ì¤‘ì‹¬ì˜ ë¦¬í¬íŠ¸ ì‘ì„± ì§€ì‹œ
    prompt = f"""
ë‹¹ì‹ ì€ ë°”ìœ CEOë¥¼ ìœ„í•´ ë§¤ì¼ ì•„ì¹¨ íˆ¬ì ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ëŠ” **ìˆ˜ì„ íˆ¬ì ë¶„ì„ê°€**ì…ë‹ˆë‹¤.
ì œê³µëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, CEOê°€ **ì›ë³¸ ë§í¬ë¥¼ í´ë¦­í•  í•„ìš”ê°€ ì—†ì„ ì •ë„ë¡œ** êµ¬ì²´ì ì´ê³  ì™„ê²°ì„± ìˆëŠ” HTML ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

[ğŸš¨ ì ˆëŒ€ ê¸ˆì§€ ì‚¬í•­]
1. **ëª¨í˜¸í•œ ì„œìˆ  ê¸ˆì§€:** '~ì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤' ëŒ€ì‹  **'~ë•Œë¬¸ì— 44ì¡° ì›ì„ ì¡°ë‹¬í–ˆìŠµë‹ˆë‹¤'**ì²˜ëŸ¼ ê²°ë¡ ë¶€í„° ë§í•˜ì„¸ìš”.
2. **í˜•ìš©ì‚¬ ë‚¨ë°œ ê¸ˆì§€:** 'íŒŒê²©ì ì¸', 'ìƒë‹¹í•œ' ëŒ€ì‹  **'ì „ë…„ ëŒ€ë¹„ 15% ìƒìŠ¹', 'ì—­ëŒ€ ìµœê³ ì¹˜ì¸ 500ë‹¬ëŸ¬ ëŒíŒŒ'** ë“± êµ¬ì²´ì  ìˆ˜ì¹˜ë¥¼ ì œì‹œí•˜ì„¸ìš”.

[ì‘ì„± ì§€ì¹¨]
1. **ì–¸ì–´**: ëª¨ë“  ë‚´ìš©ì€ **ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´**ë¡œ ì‘ì„± (ì˜ì–´ ê¸°ì‚¬ë„ ì™„ë²½ ë²ˆì—­).
2. **í˜•ì‹**: ì˜¤ì§ HTML ì½”ë“œë§Œ ì¶œë ¥ (```html íƒœê·¸ ê¸ˆì§€, <html>ë¡œ ì‹œì‘).
3. **ì¶œì²˜**: ê° ì„¹ì…˜ í•˜ë‹¨ì— `<a href="...">`ë¡œ ì›ë³¸ ë§í¬ ì œê³µ.

---

[ì„¹ì…˜ 2: ğŸ“ˆ Global Market Insight (ê´€ì‹¬ ì¢…ëª© & í•µì‹¬ ì´ìŠˆ)]
- **[ì¤‘ìš”]** ë°ì´í„°ì— í¬í•¨ëœ **'email_summary'** ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. (ì˜ìƒ ë‚´ìš©ê³¼ ì¼ê´€ì„± ìœ ì§€ í•„ìˆ˜)
- ê° ì¢…ëª©ì˜ ë“±ë½ ì›ì¸ì„ ëª…ì¾Œí•˜ê²Œ ì •ë¦¬í•˜ê³ , ë“±ë½ë¥ (change_str)ì„ í¬í•¨í•˜ì„¸ìš”.

[ì„¹ì…˜ 3: ğŸ“° Deep Dive (ì£¼ìš” ê²½ì œ ë‰´ìŠ¤ ìƒì„¸ ë¶„ì„)]
- í•´ì™¸ ë©”ì´ì € ì–¸ë¡ (Reuters, Bloomberg ë“±) ë‚´ìš©ì„ ì‹¬ì¸µ ë¶„ì„í•©ë‹ˆë‹¤.
- í˜•ì‹:
  <h4>[í‚¤ì›Œë“œ] ê¸°ì‚¬ í—¤ë“œë¼ì¸ (í•œêµ­ì–´)</h4>
  <p><b>í•µì‹¬ ë‚´ìš©:</b> ê¸°ì‚¬ì˜ ê²°ë¡ ì„ ë‘ê´„ì‹ìœ¼ë¡œ ìš”ì•½.</p>
  <ul>
    <li><b>Detail:</b> ì™œ ê·¸ëŸ° í˜„ìƒì´ ì¼ì–´ë‚¬ëŠ”ì§€ êµ¬ì²´ì  ë°°ê²½ê³¼ ìˆ˜ì¹˜ ì„œìˆ .</li>
    <li><b>Impact:</b> ì‹œì¥ì— ë¯¸ì¹  êµ¬ì²´ì  ì˜í–¥.</li>
  </ul>
  <p style="font-size:0.9em; color:gray;">ì¶œì²˜: <a href="URL">ì›ë¬¸ ì½ê¸°</a></p>
  <hr>

[ì„¹ì…˜ 4: ğŸ“º YouTube ì±„ë„ ì¸ì‚¬ì´íŠ¸ (ì•¡ê¸°ìŠ¤ ì¶”ì¶œ)]
- ì˜ìƒ ë‚´ìš©ì„ ë³´ì§€ ì•Šì•„ë„ í•µì‹¬ì„ ì•Œ ìˆ˜ ìˆê²Œ ì •ë¦¬í•˜ì„¸ìš”.
- í˜•ì‹:
  <h3>ğŸ“º [ì±„ë„ëª…] ì˜ìƒ ì œëª©</h3>
  <p><b>ğŸ’¡ í•µì‹¬ ìš”ì•½:</b> ì˜ìƒì´ ì£¼ì¥í•˜ëŠ” ê²°ë¡  í•œ ë¬¸ì¥.</p>
  <ul>
    <li><b>[ì‹œê°„] ì£¼ìš” ë‚´ìš©:</b> êµ¬ì²´ì ì¸ ì¢…ëª©ëª…, ì¶”ì²œ ì „ëµ, ìˆ˜ì¹˜ ëª…ì‹œ.</li>
  </ul>
  <p><a href="URL">ğŸ‘‰ ì˜ìƒ ë°”ë¡œê°€ê¸°</a></p>
  <hr>

[ì„¹ì…˜ 5: ğŸ”¥ Trending Now (í•«ì´ìŠˆ ì˜ìƒ)]
- ì„¤ì •ëœ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰ëœ ê°€ì¥ í•«í•œ ì˜ìƒì„ ë¶„ì„í•©ë‹ˆë‹¤.
- í˜•ì‹:
  <h3>ğŸ”¥ [í‚¤ì›Œë“œ] ì˜ìƒ ì œëª© (ì±„ë„ëª…)</h3>
  <p><b>ìš”ì•½:</b> ì´ ì˜ìƒì´ í˜„ì¬ í™”ì œê°€ ë˜ëŠ” ì´ìœ ì™€ í•µì‹¬ ë‚´ìš©.</p>
  <ul><li><b>ë‚´ìš©:</b> ìƒì„¸ ë¶„ì„ (ì‹œê°„ëŒ€ë³„)</li></ul>
  <p><a href="URL">ğŸ‘‰ ì˜ìƒ ë°”ë¡œê°€ê¸°</a></p>
  <hr>

---
[ë¶„ì„í•  ë°ì´í„°]
{full_data}
"""

    try:
        response = model.generate_content(prompt, safety_settings=safety_settings)
        # ì‘ë‹µ ì²´í¬
        if not response.parts:
            print(f"âš ï¸ AI ì‘ë‹µ ì—†ìŒ (Reason: {response.prompt_feedback})")
            return "<p>ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨ (AI ì‘ë‹µ ê±°ë¶€)</p>"
        
        ai_report_body = response.text.replace("```html", "").replace("```", "").strip()
        
        # [ìµœì¢… ì¡°ë¦½] ì˜ìƒ(0) + ëŒ€ì‹œë³´ë“œ(1) + AIë¶„ì„(2~5)
        final_html     = f"""
        <html>
        <body style="font-family: 'Malgun Gothic', sans-serif; line-height: 1.6; color: #333;">
            {video_section_html}
            {dashboard_html}
            {ai_report_body}
            <div style="margin-top: 50px; font-size: 0.8em; color: #888; text-align: center;">
                Generated by AI Daily Briefing Agent
            </div>
        </body>
        </html>
        """
        return final_html
    
    except Exception as e:
        print(f"âš ï¸ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: {e}")
        return f"<p>ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}</p>"



# -----------------------------------------------------------------------------------------------------------------------------#
# [í†µí•©] ì´ë©”ì¼ ë°œì†¡ í•¨ìˆ˜ (ìŠ¤íƒ€ì¼ + ì´ë¯¸ì§€ ì²¨ë¶€ + BCC)
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ìƒì„±ëœ HTML ë¦¬í¬íŠ¸ë¥¼ ì´ë©”ì¼ë¡œ ë°œì†¡í•©ë‹ˆë‹¤.
# Gmail SMTPë¥¼ ì‚¬ìš©í•˜ë©°, ì—¬ëŸ¬ ìˆ˜ì‹ ìì—ê²Œ BCC(ë¹„ë°€ì°¸ì¡°)ë¡œ ë°œì†¡í•©ë‹ˆë‹¤.
# íˆíŠ¸ë§µ ì´ë¯¸ì§€ë¥¼ inline ì²¨ë¶€í•˜ì—¬ ì´ë©”ì¼ ë³¸ë¬¸ì— í‘œì‹œë˜ë„ë¡ í•©ë‹ˆë‹¤.
# 
# [ì´ë©”ì¼ êµ¬ì¡°]
# - ë³¸ë¬¸: HTML ë¦¬í¬íŠ¸ (CSS ìŠ¤íƒ€ì¼ í¬í•¨)
# - ì²¨ë¶€: S&P 500 íˆíŠ¸ë§µ ì´ë¯¸ì§€ (cid: í”„ë¡œí† ì½œë¡œ ì°¸ì¡°)
# - ìˆ˜ì‹ ì: BCCë¡œ ì²˜ë¦¬í•˜ì—¬ ìˆ˜ì‹ ì ê°„ ì´ë©”ì¼ ì£¼ì†Œ ë…¸ì¶œ ë°©ì§€
# -----------------------------------------------------------------------------------------------------------------------------#

def send_email(recipients, subject, html_body, attachment_path=None):
    """
    HTML ë¦¬í¬íŠ¸ë¥¼ ì´ë©”ì¼ë¡œ ë°œì†¡í•©ë‹ˆë‹¤.
    
    Args:
        recipients (list): ìˆ˜ì‹ ì ì´ë©”ì¼ ì£¼ì†Œ ë¦¬ìŠ¤íŠ¸
        subject (str): ì´ë©”ì¼ ì œëª©
        html_body (str): HTML í˜•ì‹ì˜ ì´ë©”ì¼ ë³¸ë¬¸
        attachment_path (str): ì²¨ë¶€í•  ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ (ì„ íƒ)
    
    [Gmail SMTP ì„¤ì •]
    - ì„œë²„: smtp.gmail.com
    - í¬íŠ¸: 587 (TLS)
    - ì¸ì¦: ì•± ë¹„ë°€ë²ˆí˜¸ í•„ìš” (2ë‹¨ê³„ ì¸ì¦ í™œì„±í™” í•„ìˆ˜)
    """
    # ìˆ˜ì‹ ìê°€ ì—†ìœ¼ë©´ ë°œì†¡í•˜ì§€ ì•ŠìŒ
    if not recipients: return
    
    print(f"ğŸ“§ ì´ë©”ì¼ í†µí•© ë°œì†¡ ì¤‘ (ìˆ˜ì‹ ì {len(recipients)}ëª… - ë¹„ë°€ì°¸ì¡°)...")
    
    # [ìˆ˜ì •] configì—ì„œ ì°¾ì§€ ì•Šê³ , ìƒë‹¨ì—ì„œ ì„ ì–¸ëœ ì „ì—­ ë³€ìˆ˜ ë°”ë¡œ ì‚¬ìš©
    # í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì´ë©”ì¼ ì„¤ì • í™•ì¸ (EMAIL_SENDER, EMAIL_PASSWORD)
    if not EMAIL_SENDER or not EMAIL_PASSWORD:
        print("âŒ ì´ë©”ì¼ ì„¤ì •(EMAIL_SENDER, EMAIL_PASSWORD)ì´ ì—†ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.")
        return

    today_str = datetime.now(pytz.timezone('Asia/Seoul')).strftime("%Y-%m-%d")

    # [Step 1] CSS ìŠ¤íƒ€ì¼ ì •ì˜
    # ì´ë©”ì¼ í´ë¼ì´ì–¸íŠ¸ í˜¸í™˜ì„±ì„ ìœ„í•´ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì‚¬ìš©
    style = """<style>
        body { font-family: 'Malgun Gothic', sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; }
        h2 { border-bottom: 2px solid #2c3e50; padding-bottom: 10px; color: #2c3e50; }
        h3 { color: #2980b9; margin-top: 30px; border-left: 5px solid #2980b9; padding-left: 10px; background-color: #f4f6f7; }
        h4 { color: #c0392b; margin-top: 25px; font-weight: bold; }
        ul { background-color: #fdfdfd; padding: 10px 10px 10px 30px; border: 1px solid #eee; border-radius: 5px; }
        li { margin-bottom: 8px; }
        a { text-decoration: none; color: #27ae60; font-weight: bold; }
        .footer { margin-top: 50px; border-top: 1px solid #eee; padding-top: 20px; text-align: center; color: #888; font-size: 12px; }
    </style>"""
    
    # ì™„ì„±ëœ HTML ì´ë©”ì¼ ë³¸ë¬¸ (ìŠ¤íƒ€ì¼ + ë¦¬í¬íŠ¸ ë‚´ìš© + í‘¸í„°)
    full_html = f"""
    <html>
    <head>{style}</head>
    <body>
        <h2>ğŸ“… {today_str} íˆ¬ì ë¦¬í¬íŠ¸</h2>
        {html_body}
        <div class='footer'>Generated by Ivan Agent</div>
    </body>
    </html>
    """

    # [Step 2] MIME ë©”ì‹œì§€ êµ¬ì„± (ì´ë¯¸ì§€ ì²¨ë¶€ë¥¼ ìœ„í•´ MIMEMultipart ì‚¬ìš©)
    # 'related' íƒ€ì…: ë³¸ë¬¸ì—ì„œ ì°¸ì¡°í•˜ëŠ” ì´ë¯¸ì§€ë¥¼ í•¨ê»˜ ë¬¶ìŒ
    msg = MIMEMultipart('related')
    msg['Subject'] = subject
    msg['From'   ] = EMAIL_SENDER
    msg['To'     ] = EMAIL_SENDER           # ìˆ˜ì‹ ìì—ê²ŒëŠ” ë³´ë‚¸ ì‚¬ëŒì´ ë°›ëŠ” ì‚¬ëŒìœ¼ë¡œ ë³´ì´ê²Œ í•¨ (BCC ë³´í˜¸)
    msg['Bcc'    ] = ", ".join(recipients)  # ì‹¤ì œ ìˆ˜ì‹ ìëŠ” ë¹„ë°€ì°¸ì¡°

    # ë³¸ë¬¸ ì¶”ê°€ (alternative: í…ìŠ¤íŠ¸/HTML ì¤‘ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
    msg_alternative = MIMEMultipart('alternative')
    msg.attach(msg_alternative)
    msg_alternative.attach(MIMEText(full_html, 'html'))

    # [Step 3] ì´ë¯¸ì§€ ì²¨ë¶€ (ê²½ë¡œê°€ ìœ íš¨í•  ë•Œë§Œ)
    # cid:tradingview_mapìœ¼ë¡œ ë³¸ë¬¸ì—ì„œ ì°¸ì¡°ë¨
    if attachment_path and os.path.exists(attachment_path):
        try:
            with open(attachment_path, 'rb') as f:
                img_data = f.read()
            image = MIMEImage(img_data)
            image.add_header('Content-ID', '<tradingview_map>')  # ë³¸ë¬¸ì—ì„œ cid:tradingview_mapìœ¼ë¡œ ì°¸ì¡°
            image.add_header('Content-Disposition', 'inline', filename="market_map.png")
            msg.attach(image)
            print("   ğŸ“ íˆíŠ¸ë§µ ì´ë¯¸ì§€ ì²¨ë¶€ ì™„ë£Œ")
        except Exception as e:
            print(f"âš ï¸ ì´ë¯¸ì§€ ì²¨ë¶€ ì‹¤íŒ¨: {e}")

    # [Step 4] Gmail SMTPë¡œ ë°œì†¡
    # 587 í¬íŠ¸ + STARTTLS ì•”í˜¸í™” ì‚¬ìš© (ê¸°ì¡´ ë°©ì‹ ìœ ì§€)
    try:
        with smtplib.SMTP('smtp.gmail.com', 587) as server:
            server.starttls()  # TLS ì•”í˜¸í™” ì‹œì‘
            server.login(EMAIL_SENDER, EMAIL_PASSWORD)  # Gmail ë¡œê·¸ì¸
            server.send_message(msg)
        print("âœ… ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ")
    except Exception as e:
        print(f"âŒ ì´ë©”ì¼ ë°œì†¡ ì—ëŸ¬: {e}")



# -----------------------------------------------------------------------------------------------------------------------------#
# html to slack-text 
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” HTML í˜•ì‹ì˜ ë¦¬í¬íŠ¸ë¥¼ ìŠ¬ë™(Slack)ì—ì„œ ë³´ê¸° ì¢‹ì€ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
# ìŠ¬ë™ì€ ë§ˆí¬ë‹¤ìš´ê³¼ ìœ ì‚¬í•œ ìì²´ í¬ë§·ì„ ì‚¬ìš©í•˜ë¯€ë¡œ HTML íƒœê·¸ë¥¼ ë³€í™˜í•´ì•¼ í•©ë‹ˆë‹¤.
# ë³€í™˜ í›„ ìŠ¬ë™ì˜ mrkdwn í˜•ì‹ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

def html_to_slack_text(html_content):
    """
    HTML ë¦¬í¬íŠ¸ë¥¼ ìŠ¬ë™ì—ì„œ ë³´ê¸° ì¢‹ì€ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
    
    Args:
        html_content (str): ë³€í™˜í•  HTML ë¬¸ìì—´
    
    Returns:
        str: ìŠ¬ë™ mrkdwn í˜•ì‹ìœ¼ë¡œ ë³€í™˜ëœ í…ìŠ¤íŠ¸
    
    [ë³€í™˜ ê·œì¹™]
    - <h1>~<h6> â†’ *ì œëª©* (ë³¼ë“œ)
    - <li> â†’ â€¢ (ë¶ˆë¦¿)
    - <b>, <strong> â†’ *ë³¼ë“œ*
    - <a href="URL">TEXT</a> â†’ <URL|TEXT> (ìŠ¬ë™ ë§í¬ í˜•ì‹)
    - <hr> â†’ ---------------
    """
    if not html_content: return ""

    text = html_content
    
    # [Step 1] <style> íƒœê·¸ì™€ ê·¸ ì•ˆì˜ ë‚´ìš© ì œê±° (ê°€ì¥ ì¤‘ìš”)
    # CSS ì½”ë“œê°€ ë³¸ë¬¸ì— ë…¸ì¶œë˜ëŠ” ê²ƒì„ ë°©ì§€
    text = re.sub(r'<style>.*?</style>', '', text, flags=re.DOTALL)
    
    # [Step 2] ë¶ˆí•„ìš”í•œ ìƒìœ„ íƒœê·¸ ì œê±°
    text = text.replace("<html>", "").replace("</html>", "")
    text = text.replace("<body>", "").replace("</body>", "")
    text = text.replace("<head>", "").replace("</head>", "")
    
    # [Step 3] ì¤„ë°”ê¿ˆ ì²˜ë¦¬
    text = text.replace("<br>", "\n").replace("</p>", "\n").replace("<p>", "")
    
    # [Step 4] ì œëª© ì²˜ë¦¬ (<h3> -> *ì œëª©*)
    # ìŠ¬ë™ì—ì„œ * *ë¡œ ê°ì‹¸ë©´ ë³¼ë“œì²´
    text = re.sub(r'<h[1-6]>(.*?)</h[1-6]>', r'\n\n*\1*\n', text)
    
    # [Step 5] ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬ (<li> -> â€¢)
    text = text.replace("<ul>", ""  ).replace("</ul>", "")
    text = text.replace("<li>", "â€¢ ").replace("</li>", "\n")
    
    # [Step 6] êµµê²Œ ì²˜ë¦¬
    text = re.sub(r'<b>(.*?)</b>', r'*\1*', text)
    text = re.sub(r'<strong>(.*?)</strong>', r'*\1*', text)
    
    # [Step 7] ë§í¬ ì²˜ë¦¬ (<a href="URL">TEXT</a> -> <URL|TEXT>)
    # ìŠ¬ë™ ë§í¬ í¬ë§·: <URL|í…ìŠ¤íŠ¸>
    text = re.sub(r'<a\s+href="([^"]+)"[^>]*>(.*?)</a>', r'<\1|\2>', text)
    
    # [Step 8] êµ¬ë¶„ì„  ì²˜ë¦¬
    text = text.replace("<hr>", "\n-----------------------------------\n")
    
    # [Step 9] ë‚¨ì€ HTML íƒœê·¸ ì œê±°
    text = re.sub(r'<[^>]+>', '', text)
    
    # [Step 10] ê³µë°± ì •ë¦¬ (3ê°œ ì´ìƒ ì¤„ë°”ê¿ˆì„ 2ê°œë¡œ)
    text = re.sub(r'\n\s*\n', '\n\n', text).strip()
    
    return text



# -----------------------------------------------------------------------------------------------------------------------------#
# send slack
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ìŠ¬ë™ ì›¹í›…(Webhook)ì„ í†µí•´ ë©”ì‹œì§€ë¥¼ ë°œì†¡í•©ë‹ˆë‹¤.
# í˜„ì¬ëŠ” ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ, ìŠ¬ë™ ì—°ë™ ì‹œ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
# ì›¹í›… URLì€ ìŠ¬ë™ ì•± ì„¤ì •ì—ì„œ ìƒì„±í•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

def send_slack(webhook_url, html_body):
    """
    ìŠ¬ë™ ì›¹í›…ì„ í†µí•´ ë¦¬í¬íŠ¸ë¥¼ ë°œì†¡í•©ë‹ˆë‹¤.
    
    Args:
        webhook_url (str): ìŠ¬ë™ ì›¹í›… URL
        html_body (str): HTML í˜•ì‹ì˜ ë¦¬í¬íŠ¸ (ìë™ìœ¼ë¡œ í…ìŠ¤íŠ¸ ë³€í™˜ë¨)
    """
    print("ğŸ“¢ ìŠ¬ë™ ë°œì†¡ ì¤‘...")
    if not webhook_url:
        print("âš ï¸ ìŠ¬ë™ URLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ")
        return

    today      = datetime.now(pytz.timezone('Asia/Seoul')).strftime("%Y-%m-%d")
    # HTMLì„ ë³´ê¸° ì¢‹ì€ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
    slack_text = f"ğŸ“… *{today} ë°ì¼ë¦¬ íˆ¬ì ë¦¬í¬íŠ¸*\n\n" + html_to_slack_text(html_body)
    
    # ìŠ¬ë™ì€ ë©”ì‹œì§€ê°€ ë„ˆë¬´ ê¸¸ë©´ ì˜ë¦´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜ (4000ì ì œí•œ ë“±)
    # ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ í…ìŠ¤íŠ¸ë¡œ ë³´ëƒ…ë‹ˆë‹¤.
    payload    = {"text": slack_text}
    
    try:
        # ìŠ¬ë™ ì›¹í›… ì—”ë“œí¬ì¸íŠ¸ë¡œ POST ìš”ì²­
        response = requests.post(webhook_url, json=payload)
        if response.status_code == 200:
            print("âœ… ìŠ¬ë™ ë°œì†¡ ì™„ë£Œ")
        else:
            print(f"âŒ ìŠ¬ë™ ë°œì†¡ ì‹¤íŒ¨: {response.text}")
    except Exception as e:
        print(f"âŒ ìŠ¬ë™ ì—ëŸ¬: {e}")


# -----------------------------------------------------------------------------------------------------------------------------#
# [NEW] HTML to YouTube Description (URL ë³´ì¡´ & AI ê³ ì§€ ì¶”ê°€)
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” HTML ë¦¬í¬íŠ¸ë¥¼ ìœ íŠœë¸Œ ì˜ìƒ ì„¤ëª…(Description)ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
# ìœ íŠœë¸Œ ì„¤ëª…ì— ë§ê²Œ í˜•ì‹ì„ ì¡°ì •í•˜ê³ , AI ìƒì„± ì˜ìƒì„ì„ ê³ ì§€í•˜ëŠ” ë©´ì±…ì¡°í•­ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
# ì´ëŠ” ìœ íŠœë¸Œ ì •ì±… ì¤€ìˆ˜ë¥¼ ìœ„í•´ í•„ìˆ˜ì ì…ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

def html_to_youtube_description(html_content):
    """
    HTML ë¦¬í¬íŠ¸ë¥¼ ìœ íŠœë¸Œ ì˜ìƒ ì„¤ëª… í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
    
    Args:
        html_content (str): HTML í˜•ì‹ì˜ ë¦¬í¬íŠ¸
    
    Returns:
        str: ìœ íŠœë¸Œ ì„¤ëª…ìš© í”Œë ˆì¸ í…ìŠ¤íŠ¸ (AI ê³ ì§€ í¬í•¨)
    
    [ë³€í™˜ ê·œì¹™]
    - <h1>~<h6> â†’ â–  ì œëª©
    - <li> â†’ - í•­ëª©
    - <a href="URL">TEXT</a> â†’ TEXT: URL
    - í•˜ë‹¨ì— AI ìƒì„± ë©´ì±…ì¡°í•­ ì¶”ê°€
    """
    if not html_content: return ""
    text = html_content
    
    # ìŠ¤íƒ€ì¼ ì œê±°
    text = re.sub(r'<style>.*?</style>', '', text, flags=re.DOTALL)
    
    # íƒœê·¸ -> í…ìŠ¤íŠ¸ ë³€í™˜
    text = text.replace("<br>", "\n").replace("</p>", "\n").replace("</li>", "\n")
    text = re.sub(r'<h[1-6]>(.*?)</h[1-6]>', r'\n\nâ–  \1\n', text) 
    text = text.replace("<li>", "- ")
    
    # ë§í¬ ì²˜ë¦¬: <a href="URL">TEXT</a> -> "TEXT: URL"
    # ìœ íŠœë¸Œ ì„¤ëª…ì—ì„œ í´ë¦­ ê°€ëŠ¥í•œ ë§í¬ë¡œ í‘œì‹œë¨
    text = re.sub(r'<a\s+href="([^"]+)"[^>]*>(.*?)</a>', r'\2: \1', text)
    
    # ë‚˜ë¨¸ì§€ íƒœê·¸ ì œê±°
    text = re.sub(r'<[^>]+>', '', text)
    
    # ê³µë°± ì •ë¦¬
    text = re.sub(r'\n\s*\n', '\n\n', text).strip()
    
    # [Fix] ìœ íŠœë¸Œ ì •ì±… ì¤€ìˆ˜ë¥¼ ìœ„í•œ AI ìƒì„± ê³ ì§€ ë¬¸êµ¬ ì¶”ê°€
    # AI ìƒì„± ì½˜í…ì¸ ì„ì„ ëª…ì‹œí•´ì•¼ í•¨
    disclaimer = """
    
------------------------------------------------
âš ï¸ ì•Œë¦¼ (Disclaimer)
ì´ ì˜ìƒì€ ì¸ê³µì§€ëŠ¥(AI)ì„ í™œìš©í•˜ì—¬ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
- ëŒ€ë³¸ ë° ë¶„ì„: Google Gemini 1.5
- ìŒì„±: Qwen3-TTS
- ì˜ìƒ í¸ì§‘: Python (MoviePy)

íˆ¬ìì˜ ì±…ì„ì€ íˆ¬ìì ë³¸ì¸ì—ê²Œ ìˆìœ¼ë©°, ì œê³µëœ ì •ë³´ëŠ” ì°¸ê³ ìš©ì…ë‹ˆë‹¤.
------------------------------------------------
    """
    
    return text + disclaimer




# -----------------------------------------------------------------------------------------------------------------------------#
# [NEW] Cleanup Function (ì²­ì†Œë¶€)
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ì´ì „ ì‹¤í–‰ì—ì„œ ìƒì„±ëœ ì„ì‹œ íŒŒì¼ê³¼ ê²°ê³¼ë¬¼ì„ ì •ë¦¬í•©ë‹ˆë‹¤.
# ë§¤ ì‹¤í–‰ ì‹œì‘ ì‹œ í˜¸ì¶œë˜ì–´ ê¹¨ë—í•œ ìƒíƒœì—ì„œ ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
# logos í´ë”ëŠ” ìºì‹œ ì—­í• ì„ í•˜ë¯€ë¡œ ì‚­ì œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

def cleanup_files():
    """
    ì´ì „ ì‹¤í–‰ì˜ ì„ì‹œ íŒŒì¼ ë° ê²°ê³¼ë¬¼ì„ ì‚­ì œí•©ë‹ˆë‹¤.
    
    [ì‚­ì œ ëŒ€ìƒ]
    - *.mp4: ìƒì„±ëœ ì˜ìƒ íŒŒì¼
    - *.mp3: TTS ìŒì„± íŒŒì¼
    - *_chart.png: ì°¨íŠ¸ ì´ë¯¸ì§€
    - logo_temp.png: ì„ì‹œ ë¡œê³  íŒŒì¼
    
    [ì‚­ì œí•˜ì§€ ì•ŠëŠ” íŒŒì¼]
    - logos/*.png: ë¡œê³  ìºì‹œ (ì¬ì‚¬ìš©)
    - tradingview_map.png: íˆíŠ¸ë§µ ì´ë¯¸ì§€ (ì´ë©”ì¼ ì²¨ë¶€ìš©)
    """
    print("ğŸ§¹ ì„ì‹œ íŒŒì¼ ë° ì´ì „ ê²°ê³¼ë¬¼ ì •ë¦¬ ì¤‘...")
    
    # ì‚­ì œí•  íŒŒì¼ íŒ¨í„´ ëª©ë¡
    patterns = [
        "*.mp4",       # ëª¨ë“  ë™ì˜ìƒ íŒŒì¼ (daily_*.mp4 ë“±)
        "*.mp3",       # ëª¨ë“  ìŒì„± íŒŒì¼ (voice.mp3 ë“±)
        "*_chart.png", # ìƒì„±ëœ ì°¨íŠ¸ ì´ë¯¸ì§€
        "logo_temp.png" # í˜¹ì‹œ ëª¨ë¥¼ ì„ì‹œ ë¡œê³ 
    ]
    
    # logos í´ë” ì•ˆì˜ íŒŒì¼ì€ ì‚­ì œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ìºì‹œ ì—­í• )
    
    for pattern in patterns:
        # í˜„ì¬ í´ë”ì—ì„œ íŒ¨í„´ì— ë§ëŠ” íŒŒì¼ ì°¾ê¸°
        for file_path in glob.glob(pattern):
            try:
                os.remove(file_path)
                print(f"   - ì‚­ì œ ì™„ë£Œ: {file_path}")
            except Exception as e:
                print(f"   âš ï¸ ì‚­ì œ ì‹¤íŒ¨: {file_path} ({e})")




# -----------------------------------------------------------------------------------------------------------------------------#
# job (Final: Full Automation)
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ í•¨ìˆ˜ëŠ” ë°ì¼ë¦¬ ë¸Œë¦¬í•‘ì˜ ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜ì…ë‹ˆë‹¤.
# ë°ì´í„° ìˆ˜ì§‘ â†’ AI ë¶„ì„ â†’ ì˜ìƒ ì œì‘ â†’ ìœ íŠœë¸Œ ì—…ë¡œë“œ â†’ ì´ë©”ì¼ ë°œì†¡ê¹Œì§€ ëª¨ë“  ê³¼ì •ì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
# Docker ì»¨í…Œì´ë„ˆì—ì„œ ë§¤ì¼ ì§€ì •ëœ ì‹œê°„ì— ì‹¤í–‰ë˜ë©°, 1íšŒ ì‹¤í–‰ í›„ ì¢…ë£Œë©ë‹ˆë‹¤ (One-Shot Mode).
#
# [ì „ì²´ ì‹¤í–‰ íë¦„]
# 1. ì„ì‹œ íŒŒì¼ ì •ë¦¬ (ì´ì „ ì‹¤í–‰ ê²°ê³¼ë¬¼ ì‚­ì œ)
# 2. ë°ì´í„° ìˆ˜ì§‘ (ì£¼ì‹, ë‰´ìŠ¤, ìœ íŠœë¸Œ, ê²½ì œ ì§€í‘œ)
# 3. AI ë¶„ì„ ë° ëŒ€ë³¸ ìƒì„±
# 4. ì˜ìƒ ì œì‘ (video_studio ëª¨ë“ˆ)
# 5. ìœ íŠœë¸Œ Shorts ì—…ë¡œë“œ
# 6. ì´ë©”ì¼ ë¦¬í¬íŠ¸ ë°œì†¡
# -----------------------------------------------------------------------------------------------------------------------------#

def job():
    """
    ë°ì¼ë¦¬ ë¸Œë¦¬í•‘ì˜ ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
    
    ëª¨ë“  ë‹¨ê³„ê°€ try-exceptë¡œ ë³´í˜¸ë˜ì–´ ìˆì–´ ì¼ë¶€ ë‹¨ê³„ ì‹¤íŒ¨ ì‹œì—ë„ 
    ê°€ëŠ¥í•œ ë¶€ë¶„ê¹Œì§€ ì§„í–‰ë©ë‹ˆë‹¤.
    """
    print(f"\nğŸš€ [Final] ë°ì¼ë¦¬ ë¸Œë¦¬í•‘ ì‹œì‘: {datetime.now()}")
    
    # [Step 0] ì‹œì‘ ì „ ì„ì‹œ íŒŒì¼ ì •ë¦¬
    # ì´ì „ ì‹¤í–‰ì—ì„œ ìƒì„±ëœ mp4, mp3, ì°¨íŠ¸ ì´ë¯¸ì§€ ë“±ì„ ì‚­ì œ
    cleanup_files()
    
    # [Step 1] ì„¤ì • íŒŒì¼ ë¡œë“œ
    config = load_config()
    if not config: 
        print("âŒ ì„¤ì • íŒŒì¼(config.json)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    today_str        = datetime.now(pytz.timezone('Asia/Seoul')).strftime("%Y-%m-%d")
    
    # ========================================================================================
    # [Phase 1] ë°ì´í„° ìˆ˜ì§‘
    # ========================================================================================
    # ê° í•¨ìˆ˜ëŠ” ë…ë¦½ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ë©°, ì¼ë¶€ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ë°ì´í„°ë¡œ ì§„í–‰ ê°€ëŠ¥
    stocks           = collect_stock_data(config.get('stock_tickers', []))          # ì£¼ì‹ ì‹œì„¸ + ê´€ë ¨ ë‰´ìŠ¤
    general_news     = fetch_news_raw(config.get('news_keywords', []), limit=3)     # ì¼ë°˜ ë‰´ìŠ¤
    channel_videos   = collect_channel_youtube_data(config.get('youtube_channels', {}))  # ì±„ë„ ìœ íŠœë¸Œ
    trend_videos     = collect_keyword_youtube_data(config.get('youtube_keywords', []))  # íŠ¸ë Œë“œ ìœ íŠœë¸Œ
    all_youtube      = channel_videos + trend_videos                                # ëª¨ë“  ìœ íŠœë¸Œ í•©ì¹˜ê¸°
    economy_news_raw = collect_economy_data()                                       # ê²½ì œ ì§€í‘œ + ê³µí¬ì§€ìˆ˜
    
    # ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì§„í–‰
    if stocks or general_news or all_youtube:
        try:
            # [ìˆ˜ì • 1] ë³€ìˆ˜ ë¯¸ë¦¬ ì´ˆê¸°í™” (ì—ëŸ¬ ë°©ì§€ìš©)
            # ì˜ìƒ ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œì—ë„ ì´ë©”ì¼ ë°œì†¡ ë‹¨ê³„ì—ì„œ ì—ëŸ¬ ë°©ì§€
            video_url = None 
            
            # ========================================================================================
            # [Phase 2] AI ë¶„ì„ ë° ëŒ€ë³¸ ìƒì„±
            # ========================================================================================
            # analyze_and_summarizeì—ì„œ ë°ì´í„° ë¶„ì„ + ì˜ìƒ ëŒ€ë³¸ê¹Œì§€ í•œ ë²ˆì— ìƒì„±
            stocks, general_news, all_youtube, economy_data, generated_scripts = analyze_and_summarize(stocks, general_news, all_youtube, economy_news_raw)
            
            video_title = "ê¸€ë¡œë²Œ ì¦ì‹œ ë¸Œë¦¬í•‘"
            print(f"ğŸ¬ ëŒ€ë³¸ ë° ì½˜í…ì¸  í™•ì •: {video_title}")
            
            # video_studioì— ì „ë‹¬í•  êµ¬ì¡°í™”ëœ ë°ì´í„°
            structured_data = {
                'stocks'  : stocks,
                'news'    : general_news,
                'youtube' : all_youtube,
                'economy' : economy_data
            }

            # ========================================================================================
            # [Phase 3] ì˜ìƒ ì œì‘
            # ========================================================================================
            map_image_path = "tradingview_map.png"  # ìº¡ì²˜ëœ íˆíŠ¸ë§µ íŒŒì¼ëª… ì˜ˆìƒ

            # video_studio ëª¨ë“ˆì˜ make_video_module í•¨ìˆ˜ í˜¸ì¶œ
            if hasattr(video_studio, 'make_video_module'):
                # TTS ì„¤ì • ì „ë‹¬ (Qwen3-TTS API ì„œë²„ ì„¤ì •)
                tts_config = config.get('tts_config', {})
                if hasattr(video_studio, 'set_tts_config'):
                    video_studio.set_tts_config(tts_config)
                    print(f"ğŸ”Š TTS ì„¤ì • ì ìš©: {tts_config.get('server_url', 'http://localhost:8002')}")
                
                video_file = video_studio.make_video_module(
                    scene_scripts   = generated_scripts,   # AIê°€ ìƒì„±í•œ 6ê°œ ì”¬ ëŒ€ë³¸
                    structured_data = structured_data,     # ì‹œê°í™”ì— í•„ìš”í•œ ë°ì´í„°
                    date_str        = today_str            # ë‚ ì§œ ë¬¸ìì—´
                )                
                
                # ì˜ìƒ ì™„ë£Œ í›„ ë§µ ì´ë¯¸ì§€ê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸ (video_studio ë‚´ë¶€ì—ì„œ capture ìˆ˜í–‰í•¨)
                if not os.path.exists(map_image_path):
                    print("âš ï¸ ë§µ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ. ë©”ì¼ ì²¨ë¶€ ì‹¤íŒ¨ ê°€ëŠ¥ì„±.")

                # ========================================================================================
                # [Phase 4] ìœ íŠœë¸Œ ì—…ë¡œë“œ
                # ========================================================================================
                if video_file and os.path.exists(video_file):
                    
                    print("ğŸ“¤ ìœ íŠœë¸Œ ì—…ë¡œë“œ ì‹œì‘...")
                    # ìœ íŠœë¸Œ ì„¤ëª…ìš© í…ìŠ¤íŠ¸ ìƒì„± (HTML â†’ í”Œë ˆì¸ í…ìŠ¤íŠ¸ + AI ê³ ì§€)
                    temp_report = generate_report(stocks, general_news, channel_videos, trend_videos, video_url=None, economy_data=economy_data)
                    desc_text   = html_to_youtube_description(temp_report)
                    
                    # youtube_manager ëª¨ë“ˆë¡œ Shorts ì—…ë¡œë“œ
                    video_url = youtube_manager.upload_short(
                        video_file, 
                        title       = f"{today_str}ì¼ì- {video_title}", 
                        description = desc_text
                    )
                    print(f"âœ… ì—…ë¡œë“œ ì™„ë£Œ: {video_url}")
                else:
                    print("âš ï¸ ìƒì„±ëœ ì˜ìƒ íŒŒì¼ì´ ì—†ê±°ë‚˜ video_studioì—ì„œ ë°˜í™˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            else:
                print("âš ï¸ video_studio ëª¨ë“ˆ ì˜¤ë¥˜: make_video_module í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.")
            
            # ========================================================================================
            # [Phase 5] ì´ë©”ì¼ ë¦¬í¬íŠ¸ ë°œì†¡
            # ========================================================================================
            # video_urlì´ Noneì´ì–´ë„ ì•ˆì „í•˜ê²Œ ì²´í¬
            if video_url:
                print("ğŸ“§ ë¦¬í¬íŠ¸ ë°°í¬ ì¤€ë¹„...")
                # ì˜ìƒ URLì´ í¬í•¨ëœ ìµœì¢… ë¦¬í¬íŠ¸ ìƒì„±
                report = generate_report(stocks, general_news, channel_videos, trend_videos, video_url, economy_data=economy_data)
                # [ìˆ˜ì •ëœ í˜¸ì¶œ ë°©ì‹]
                # ì¸ì ìˆœì„œ: ìˆ˜ì‹ ìëª©ë¡, ì œëª©, HTMLë³¸ë¬¸, ì²¨ë¶€íŒŒì¼ê²½ë¡œ
                send_email(
                    recipients      = config.get('email_recipients', []), 
                    subject         = f"[Insight] {today_str} ê¸€ë¡œë²Œ ì¦ì‹œ ë¸Œë¦¬í•‘", 
                    html_body       = report, 
                    attachment_path = "tradingview_map.png"  # video_studioê°€ ë§Œë“  íˆíŠ¸ë§µ ì´ë¯¸ì§€
                )
                
            else:
                print("âš ï¸ ì˜ìƒ URL ì—†ìŒ. ë¦¬í¬íŠ¸ ë°œì†¡ ìŠ¤í‚µ.")

        except Exception as e:
            # ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì¤‘ ì˜ˆì™¸ ë°œìƒ ì‹œ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ì¶œë ¥
            print(f"âš ï¸ ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì¤‘ ì—ëŸ¬: {e}")
            import traceback
            traceback.print_exc()
            
    else:
        # ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì „í˜€ ì—†ëŠ” ê²½ìš° (API ì¥ì• , íœ´ì¥ì¼ ë“±)
        print("ğŸ’¤ ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

    print("ğŸ [Final] ëª¨ë“  ì‘ì—… ì™„ë£Œ\n")



# -----------------------------------------------------------------------------------------------------------------------------#
# main (One-Shot Execution)
# -----------------------------------------------------------------------------------------------------------------------------#
# ì´ ë¸”ë¡ì€ ìŠ¤í¬ë¦½íŠ¸ê°€ ì§ì ‘ ì‹¤í–‰ë  ë•Œë§Œ ë™ì‘í•©ë‹ˆë‹¤ (import ì‹œì—ëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŒ).
# Docker ì»¨í…Œì´ë„ˆì—ì„œ python agent.py ëª…ë ¹ìœ¼ë¡œ ì‹¤í–‰ë˜ë©°,
# job() í•¨ìˆ˜ë¥¼ 1íšŒ í˜¸ì¶œí•œ í›„ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë©ë‹ˆë‹¤.
# í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ Docker ì»¨í…Œì´ë„ˆë„ ìë™ìœ¼ë¡œ ì¢…ë£Œë©ë‹ˆë‹¤.
# 
# [ìŠ¤ì¼€ì¤„ë§ ë°©ì‹]
# ì´ ìŠ¤í¬ë¦½íŠ¸ ìì²´ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
# ëŒ€ì‹  Docker Compose ë˜ëŠ” ì™¸ë¶€ cronì—ì„œ ë§¤ì¼ ì§€ì •ëœ ì‹œê°„ì— ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------------------------------------------------------#

if __name__ == "__main__":
    print(f"[{datetime.now()}] ë°ì¼ë¦¬ ë¸Œë¦¬í•‘ ì—ì´ì „íŠ¸ ì‹¤í–‰ (One-Shot Mode)")

    # job í•¨ìˆ˜ë¥¼ 1íšŒ ì‹¤í–‰
    job()

    print(f"[{datetime.now()}] ëª¨ë“  ì‘ì—… ì™„ë£Œ. í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    # ë£¨í”„ ì—†ì´ ì—¬ê¸°ì„œ í”„ë¡œê·¸ë¨ì´ ëë‚˜ë©´, ë„ì»¤ ì»¨í…Œì´ë„ˆë„ ìë™ìœ¼ë¡œ êº¼ì§‘ë‹ˆë‹¤.


# -----------------------------------------------------------------------------------------------------------------------------#
